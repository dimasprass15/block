<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blast Hijaiyah - Block Puzzle Game</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        @import url('https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Scheherazade+New:wght@400;700&display=swap');
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            background-size: 400% 400%;
            animation: gradientShift 8s ease infinite;
            min-height: 100vh;
            color: white;
            padding: 20px;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .game-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .game-title {
            font-size: 3rem;
            font-weight: 900;
            background: linear-gradient(45deg, #ffd700, #ff6b6b, #4ecdc4, #45b7d1);
            background-size: 300% 300%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: titleGlow 3s ease-in-out infinite;
            margin-bottom: 10px;
        }

        @keyframes titleGlow {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .game-subtitle {
            font-size: 1.3rem;
            opacity: 0.9;
            margin-bottom: 20px;
        }

        .main-container {
            display: flex;
            gap: 30px;
            max-width: 1400px;
            margin: 0 auto;
            align-items: flex-start;
        }

        .game-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .game-board {
            width: 480px;
            height: 480px;
            background: linear-gradient(135deg, rgba(0,0,0,0.3), rgba(0,0,0,0.1));
            border: 4px solid rgba(255,255,255,0.3);
            border-radius: 20px;
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            grid-template-rows: repeat(8, 1fr);
            gap: 2px;
            padding: 10px;
            backdrop-filter: blur(15px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            margin-bottom: 30px;
        }

        .grid-cell {
            background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Scheherazade New', 'Amiri', serif;
            font-size: 2.2rem;
            font-weight: 700;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }

        .grid-cell.filled {
            background: linear-gradient(135deg, #4ecdc4, #44a08d);
            border-color: rgba(78,205,196,0.8);
            box-shadow: 0 0 15px rgba(78,205,196,0.4);
            color: white;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .grid-cell.highlight {
            background: linear-gradient(135deg, #ffd700, #ffb347);
            border-color: rgba(255,215,0,0.8);
            box-shadow: 0 0 20px rgba(255,215,0,0.6);
            animation: pulse 0.5s ease-in-out infinite alternate;
        }

        .grid-cell.clearing {
            animation: clearEffect 0.6s ease-out forwards;
        }



        @keyframes pulse {
            0% { transform: scale(1); }
            100% { transform: scale(1.05); }
        }

        @keyframes clearEffect {
            0% { transform: scale(1) rotate(0deg); opacity: 1; }
            50% { transform: scale(1.2) rotate(180deg); opacity: 0.8; }
            100% { transform: scale(0) rotate(360deg); opacity: 0; }
        }

        .pieces-container {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-bottom: 20px;
        }

        .piece-holder {
            width: 120px;
            height: 120px;
            background: linear-gradient(135deg, rgba(255,255,255,0.15), rgba(255,255,255,0.05));
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .piece-holder:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.3);
            border-color: rgba(78,205,196,0.6);
        }

        .piece-holder.selected {
            border-color: #ffd700;
            box-shadow: 0 0 25px rgba(255,215,0,0.6);
            transform: scale(1.05);
        }

        .piece-holder.empty {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .piece {
            display: grid;
            gap: 2px;
        }

        .piece-cell {
            width: 16px;
            height: 16px;
            background: linear-gradient(135deg, #4ecdc4, #44a08d);
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Scheherazade New', 'Amiri', serif;
            font-size: 0.9rem;
            font-weight: 700;
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }

        .sidebar {
            width: 320px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .info-panel {
            background: linear-gradient(135deg, rgba(255,255,255,0.15), rgba(255,255,255,0.05));
            border-radius: 20px;
            padding: 25px;
            backdrop-filter: blur(15px);
            border: 2px solid rgba(255,255,255,0.2);
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .score-display {
            text-align: center;
            margin-bottom: 20px;
        }

        .score-label {
            font-size: 1.1rem;
            opacity: 0.8;
            margin-bottom: 5px;
        }

        .score-value {
            font-size: 2.5rem;
            font-weight: 900;
            color: #ffd700;
            text-shadow: 0 0 15px rgba(255,215,0,0.5);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-item {
            text-align: center;
            background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
            padding: 15px;
            border-radius: 15px;
            border: 2px solid rgba(255,255,255,0.2);
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #4ecdc4;
        }

        .btn {
            background: linear-gradient(135deg, #4ecdc4, #44a08d);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(78,205,196,0.3);
            text-transform: uppercase;
            letter-spacing: 1px;
            width: 100%;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 30px rgba(78,205,196,0.4);
        }

        .btn.secondary {
            background: linear-gradient(135deg, #95a5a6, #7f8c8d);
            box-shadow: 0 8px 25px rgba(149,165,166,0.3);
        }

        .btn.secondary:hover {
            box-shadow: 0 12px 30px rgba(149,165,166,0.4);
        }

        .btn.danger {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            box-shadow: 0 8px 25px rgba(255,107,107,0.3);
        }

        .btn.danger:hover {
            box-shadow: 0 12px 30px rgba(255,107,107,0.4);
        }

        .learning-popup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(0,0,0,0.9), rgba(44,62,80,0.8));
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(15px);
        }

        .learning-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            background-size: 400% 400%;
            animation: gradientShift 8s ease infinite, popupAppear 0.6s ease-out;
            color: white;
            border-radius: 30px;
            padding: 50px;
            max-width: 600px;
            text-align: center;
            box-shadow: 0 30px 80px rgba(0,0,0,0.5), 0 0 50px rgba(255,255,255,0.1);
            border: 3px solid rgba(255,255,255,0.3);
            position: relative;
            overflow: hidden;
        }



        @keyframes popupAppear {
            0% { 
                transform: scale(0.5) rotate(-10deg); 
                opacity: 0; 
                filter: blur(10px);
            }
            50% { 
                transform: scale(1.05) rotate(2deg); 
                opacity: 0.8; 
                filter: blur(2px);
            }
            100% { 
                transform: scale(1) rotate(0deg); 
                opacity: 1; 
                filter: blur(0px);
            }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }

        .learning-arabic {
            font-family: 'Scheherazade New', 'Amiri', serif;
            font-size: 8rem;
            font-weight: 700;
            margin: 30px 0;
            color: #fff;
            text-shadow: 0 0 30px rgba(255,255,255,0.8), 0 0 60px rgba(255,215,0,0.6), 0 5px 15px rgba(0,0,0,0.3);
            position: relative;
            z-index: 2;
        }

        .learning-title {
            font-size: 2.2rem;
            font-weight: 800;
            margin-bottom: 20px;
            color: #fff;
            text-shadow: 0 3px 10px rgba(0,0,0,0.3);
            position: relative;
            z-index: 2;
        }



        .learning-meaning {
            font-size: 1.4rem;
            color: #fff;
            margin: 20px 0;
            line-height: 1.6;
            text-shadow: 0 2px 8px rgba(0,0,0,0.3);
            position: relative;
            z-index: 2;
            font-weight: 600;
        }

        .quiz-container {
            background: linear-gradient(135deg, rgba(52,152,219,0.2), rgba(52,152,219,0.1));
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            border: 2px solid rgba(52,152,219,0.3);
        }

        .quiz-question {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: #2c3e50;
        }

        .quiz-options {
            display: grid;
            gap: 10px;
            margin-bottom: 15px;
        }

        .quiz-option {
            background: rgba(255,255,255,0.7);
            border: 2px solid rgba(52,152,219,0.3);
            border-radius: 10px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .quiz-option:hover {
            background: rgba(52,152,219,0.2);
            border-color: rgba(52,152,219,0.6);
        }

        .quiz-option.correct {
            background: rgba(46,204,113,0.3);
            border-color: rgba(46,204,113,0.6);
        }

        .quiz-option.wrong {
            background: rgba(231,76,60,0.3);
            border-color: rgba(231,76,60,0.6);
        }

        .game-over-popup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(15px);
        }

        .game-over-content {
            background: linear-gradient(135deg, rgba(255,255,255,0.95), rgba(255,255,255,0.85));
            color: #333;
            border-radius: 25px;
            padding: 40px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            animation: popupAppear 0.5s ease-out;
            max-width: 500px;
        }

        .game-over-title {
            font-size: 2.5rem;
            font-weight: 900;
            margin-bottom: 20px;
            color: #e74c3c;
        }

        .final-stats {
            background: linear-gradient(135deg, rgba(52,152,219,0.2), rgba(52,152,219,0.1));
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            border: 2px solid rgba(52,152,219,0.3);
        }

        .admin-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 100;
        }

        .admin-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100vh;
            background: linear-gradient(135deg, rgba(0,0,0,0.95), rgba(0,0,0,0.85));
            backdrop-filter: blur(20px);
            border-left: 3px solid rgba(255,255,255,0.3);
            padding: 20px;
            overflow-y: auto;
            transition: right 0.3s ease;
            z-index: 999;
        }

        .admin-panel.open {
            right: 0;
        }

        .admin-section {
            background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border: 2px solid rgba(255,255,255,0.2);
        }

        .admin-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #ffd700;
            margin-bottom: 15px;
            text-align: center;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 5px;
            color: #4ecdc4;
        }

        .form-input, .form-textarea, .form-select {
            width: 100%;
            padding: 10px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 8px;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 0.9rem;
            backdrop-filter: blur(5px);
        }

        .form-input:focus, .form-textarea:focus, .form-select:focus {
            outline: none;
            border-color: rgba(78,205,196,0.8);
            box-shadow: 0 0 10px rgba(78,205,196,0.3);
        }

        .form-input::placeholder, .form-textarea::placeholder {
            color: rgba(255,255,255,0.6);
        }

        .range-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .range-input {
            flex: 1;
            height: 6px;
            border-radius: 3px;
            background: rgba(255,255,255,0.2);
            outline: none;
            -webkit-appearance: none;
        }

        .range-input::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: linear-gradient(135deg, #4ecdc4, #44a08d);
            cursor: pointer;
        }

        .range-value {
            background: linear-gradient(135deg, #4ecdc4, #44a08d);
            color: white;
            padding: 4px 10px;
            border-radius: 10px;
            font-weight: 600;
            min-width: 40px;
            text-align: center;
            font-size: 0.9rem;
        }

        @media (max-width: 1200px) {
            .main-container {
                flex-direction: column;
                align-items: center;
            }
            
            .sidebar {
                width: 100%;
                max-width: 600px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        @media (max-width: 768px) {
            .game-board {
                width: 320px;
                height: 320px;
            }
            
            .grid-cell {
                font-size: 1.2rem;
            }
            
            .pieces-container {
                flex-wrap: wrap;
            }
            
            .piece-holder {
                width: 100px;
                height: 100px;
            }
            
            .game-title {
                font-size: 2rem;
            }
            
            .admin-panel {
                width: 100%;
                right: -100%;
            }
        }
    </style>
</head>
<body>
    <!-- Admin Toggle -->
    <div class="admin-toggle">
        <button class="btn secondary" onclick="toggleAdmin()">‚öôÔ∏è Admin</button>
    </div>

    <!-- Game Header -->
    <div class="game-header">
        <h1 class="game-title">üïå Blast Hijaiyah</h1>
        <p class="game-subtitle">Block Puzzle dengan Pembelajaran Huruf Arab</p>
    </div>

    <!-- Main Game Container -->
    <div class="main-container">
        <!-- Game Area -->
        <div class="game-area">
            <!-- Game Board -->
            <div class="game-board" id="gameBoard"></div>
            
            <!-- Pieces Container -->
            <div class="pieces-container" id="piecesContainer">
                <div class="piece-holder" id="piece1" onclick="selectPiece(0)"></div>
                <div class="piece-holder" id="piece2" onclick="selectPiece(1)"></div>
                <div class="piece-holder" id="piece3" onclick="selectPiece(2)"></div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="sidebar">
            <!-- Score Panel -->
            <div class="info-panel">
                <div class="score-display">
                    <div class="score-label">üìä SKOR</div>
                    <div class="score-value" id="scoreValue">0</div>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-label">Baris Cleared</div>
                        <div class="stat-value" id="linesCleared">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Combo</div>
                        <div class="stat-value" id="comboCount">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Level</div>
                        <div class="stat-value" id="currentLevel">1</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Pieces</div>
                        <div class="stat-value" id="piecesPlaced">0</div>
                    </div>
                </div>
            </div>

            <!-- Game Controls -->
            <div class="info-panel">
                <button class="btn" onclick="startNewGame()">üéÆ Game Baru</button>
                <button class="btn secondary" onclick="showHowToPlay()">‚ùì Cara Main</button>
                <button class="btn secondary" onclick="showAchievements()">üèÜ Achievement</button>
                <button class="btn danger" onclick="resetProgress()">üîÑ Reset Progress</button>
            </div>
        </div>
    </div>

    <!-- Admin Panel -->
    <div class="admin-panel" id="adminPanel">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid rgba(255,255,255,0.2);">
            <h2 style="color: #ffd700; margin: 0; font-size: 1.5rem;">‚öôÔ∏è Admin Panel</h2>
            <button class="btn danger" onclick="toggleAdmin()" style="padding: 8px 15px; font-size: 0.9rem; margin: 0;">‚úï Tutup</button>
        </div>
        
        <div class="admin-section">
            <div class="admin-title">‚öôÔ∏è Game Settings</div>
            
            <div class="form-group">
                <label class="form-label">üéØ Learning Trigger</label>
                <div class="range-container">
                    <input type="range" class="range-input" id="learningTrigger" min="1" max="10" value="3">
                    <div class="range-value" id="learningTriggerValue">3</div>
                </div>
                <small style="opacity: 0.8;">Popup pembelajaran setiap X clear</small>
            </div>

            <div class="form-group">
                <label class="form-label">üí∞ Score Multiplier</label>
                <div class="range-container">
                    <input type="range" class="range-input" id="scoreMultiplier" min="0.5" max="3" step="0.1" value="1">
                    <div class="range-value" id="scoreMultiplierValue">1x</div>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">üé≤ Combo Bonus</label>
                <div class="range-container">
                    <input type="range" class="range-input" id="comboBonus" min="100" max="1000" step="50" value="200">
                    <div class="range-value" id="comboBonusValue">200</div>
                </div>
            </div>

            <button class="btn" onclick="saveGameSettings()">üíæ Simpan Settings</button>
        </div>

        <div class="admin-section">
            <div class="admin-title">üìö Level Management</div>
            
            <div class="form-group">
                <label class="form-label">üéØ Level Game</label>
                <input type="number" class="form-input" id="gameLevel" min="1" max="20" value="1" placeholder="1">
            </div>

            <div class="form-group">
                <label class="form-label">üìù Nama Level</label>
                <input type="text" class="form-input" id="levelName" placeholder="Level 1 - Hijaiyah Dasar">
            </div>

            <div class="form-group">
                <label class="form-label">üìö Huruf-huruf Level Ini</label>
                <textarea class="form-textarea" id="levelLetters" placeholder="Masukkan huruf Arab dipisah koma: ÿß, ÿ®, ÿ™, ÿ´, ÿ¨" style="font-size: 1.2rem; text-align: center; height: 80px;"></textarea>
                <small style="opacity: 0.8;">Contoh: ÿß, ÿ®, ÿ™, ÿ´, ÿ¨</small>
            </div>

            <button class="btn" onclick="saveLevelContent()">üíæ Simpan Level</button>
            <button class="btn secondary" onclick="showAllLevels()">üìã Lihat Semua Level</button>
            <button class="btn secondary" onclick="loadLevelForEdit()">‚úèÔ∏è Edit Level</button>
        </div>

        <div class="admin-section">
            <div class="admin-title">üèÜ Achievements</div>
            
            <div class="form-group">
                <label class="form-label">üéØ Nama Achievement</label>
                <input type="text" class="form-input" id="achievementName" placeholder="Master Combo">
            </div>

            <div class="form-group">
                <label class="form-label">üé® Icon (Emoji)</label>
                <input type="text" class="form-input" id="achievementIcon" placeholder="üî•">
            </div>

            <div class="form-group">
                <label class="form-label">üìù Deskripsi</label>
                <input type="text" class="form-input" id="achievementDesc" placeholder="Clear 5 baris sekaligus">
            </div>

            <div class="form-group">
                <label class="form-label">‚öôÔ∏è Kondisi</label>
                <select class="form-select" id="achievementCondition">
                    <option value="score">Skor Tertentu</option>
                    <option value="lines">Baris Cleared</option>
                    <option value="combo">Combo Tertentu</option>
                    <option value="pieces">Pieces Placed</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">üéØ Target</label>
                <input type="number" class="form-input" id="achievementTarget" placeholder="5000">
            </div>

            <button class="btn" onclick="addAchievement()">‚ûï Tambah Achievement</button>
            <button class="btn secondary" onclick="showAchievementsList()">üèÜ Lihat Achievements</button>
        </div>

        <div class="admin-section">
            <div class="admin-title">üíæ Data Management</div>
            <button class="btn" onclick="exportAllData()">üì§ Export Semua Data</button>
            <button class="btn secondary" onclick="importData()">üì• Import Data</button>
            <button class="btn danger" onclick="resetAllData()">üîÑ Reset Semua</button>
            <input type="file" id="importFile" accept=".json" style="display: none;" onchange="handleImport()">
        </div>
    </div>

    <!-- Learning Popup -->
    <div class="learning-popup" id="learningPopup">
        <div class="learning-content">
            <div class="learning-title" id="learningTitle">üïå Belajar Dulu Ya !</div>
            <div class="learning-meaning" id="learningMeaning">Ikuti Bacaan Ustadz/ah</div>
            <div class="learning-arabic" id="learningArabic">ÿß</div>
            
            <div class="quiz-container" id="quizContainer" style="display: none;">
                <div class="quiz-question" id="quizQuestion">Bagaimana cara membaca huruf ini?</div>
                <div class="quiz-options" id="quizOptions"></div>
            </div>
            
            <div style="margin-top: 40px; position: relative; z-index: 2;" id="evaluationButtons">
                <button class="btn" onclick="closeLearningPopup()" style="background: linear-gradient(135deg, #27ae60, #2ecc71); font-size: 1.2rem; padding: 18px 35px; box-shadow: 0 10px 30px rgba(39,174,96,0.4); border: 2px solid rgba(255,255,255,0.3);">‚úÖ Mengerti!</button>
            </div>
        </div>
    </div>

    <!-- Password Popup -->
    <div class="learning-popup" id="passwordPopup" style="display: none;">
        <div class="learning-content" style="max-width: 400px; padding: 40px;">
            <div class="learning-title">üîê Admin Access</div>
            <div class="learning-meaning" style="margin-bottom: 30px;">Masukkan password untuk mengakses Admin Panel</div>
            
            <div style="margin: 30px 0;">
                <input type="password" id="adminPassword" placeholder="Masukkan password..." 
                       style="width: 100%; padding: 15px; border: 2px solid rgba(255,255,255,0.3); border-radius: 15px; background: rgba(255,255,255,0.1); color: white; font-size: 1.1rem; text-align: center; backdrop-filter: blur(5px);"
                       onkeypress="if(event.key==='Enter') checkAdminPassword()">
            </div>
            
            <div id="passwordError" style="color: #ff6b6b; text-align: center; margin: 15px 0; font-weight: 600; display: none;">
                ‚ùå Password salah! Coba lagi.
            </div>
            
            <div style="margin-top: 30px; display: flex; gap: 15px;">
                <button class="btn" onclick="checkAdminPassword()" style="flex: 1; background: linear-gradient(135deg, #27ae60, #2ecc71);">
                    üîì Masuk
                </button>
                <button class="btn secondary" onclick="closePasswordPopup()" style="flex: 1;">
                    ‚ùå Batal
                </button>
            </div>
        </div>
    </div>

    <!-- Game Over Popup -->
    <div class="game-over-popup" id="gameOverPopup">
        <div class="game-over-content">
            <div class="game-over-title">üéÆ Game Over!</div>
            <div class="final-stats">
                <h3 style="margin-bottom: 15px; color: #2c3e50;">üìä Statistik Final</h3>
                <div id="finalStats"></div>
            </div>
            <div id="newAchievements" style="display: none;">
                <h3 style="margin-bottom: 15px; color: #f39c12;">üèÜ Achievement Baru!</h3>
                <div id="achievementsList"></div>
            </div>
            <div style="margin-top: 30px;">
                <button class="btn" onclick="startNewGame(); closeGameOver();">üéÆ Main Lagi</button>
                <button class="btn secondary" onclick="closeGameOver()">üìä Tutup</button>
            </div>
        </div>
    </div>

    <script>
        // ===== GAME VARIABLES =====
        const GRID_SIZE = 8;
        let gameBoard = [];
        let currentPieces = [];
        let selectedPieceIndex = -1;
        let gameRunning = false;

        // Game Statistics
        let gameStats = {
            score: 0,
            linesCleared: 0,
            comboCount: 0,
            currentLevel: 1,
            piecesPlaced: 0,
            totalClears: 0
        };

        // Game Settings (loaded from admin)
        let gameSettings = {
            learningTrigger: 3,
            scoreMultiplier: 1,
            comboBonus: 200
        };

        // Level-based Learning Content (customizable through admin)
        let levelBasedModules = {};

        // Legacy learning modules for backward compatibility
        let learningModules = [];

        // Achievements
        let achievements = [
            {
                id: 'first_clear',
                name: 'Pembersih Pertama',
                icon: 'üßπ',
                description: 'Clear baris/kolom pertama',
                condition: 'lines',
                target: 1
            },
            {
                id: 'combo_master',
                name: 'Master Combo',
                icon: 'üî•',
                description: 'Buat combo 5x berturut-turut',
                condition: 'combo',
                target: 5
            },
            {
                id: 'high_scorer',
                name: 'High Scorer',
                icon: 'üíé',
                description: 'Capai skor 10,000',
                condition: 'score',
                target: 10000
            }
        ];

        let unlockedAchievements = [];

        // Arabic Letters for pieces with colors
        const arabicLetters = [
            { letter: 'ÿß', color: '#e74c3c' },  // Red
            { letter: 'ÿ®', color: '#3498db' },  // Blue
            { letter: 'ÿ™', color: '#2ecc71' },  // Green
            { letter: 'ÿ´', color: '#f39c12' },  // Orange
            { letter: 'ÿ¨', color: '#9b59b6' },  // Purple
            { letter: 'ÿ≠', color: '#1abc9c' },  // Turquoise
            { letter: 'ÿÆ', color: '#e67e22' },  // Dark Orange
            { letter: 'ÿØ', color: '#34495e' },  // Dark Blue
            { letter: 'ÿ∞', color: '#e91e63' },  // Pink
            { letter: 'ÿ±', color: '#00bcd4' },  // Cyan
            { letter: 'ÿ≤', color: '#ff5722' },  // Deep Orange
            { letter: 'ÿ≥', color: '#795548' },  // Brown
            { letter: 'ÿ¥', color: '#607d8b' },  // Blue Grey
            { letter: 'ÿµ', color: '#8bc34a' },  // Light Green
            { letter: 'ÿ∂', color: '#ffc107' },  // Amber
            { letter: 'ÿ∑', color: '#673ab7' },  // Deep Purple
            { letter: 'ÿ∏', color: '#009688' },  // Teal
            { letter: 'ÿπ', color: '#ff9800' },  // Orange
            { letter: 'ÿ∫', color: '#4caf50' },  // Green
            { letter: 'ŸÅ', color: '#2196f3' },  // Blue
            { letter: 'ŸÇ', color: '#f44336' },  // Red
            { letter: 'ŸÉ', color: '#9c27b0' },  // Purple
            { letter: 'ŸÑ', color: '#00e676' },  // Green Accent
            { letter: 'ŸÖ', color: '#ff6d00' },  // Orange Accent
            { letter: 'ŸÜ', color: '#3f51b5' },  // Indigo
            { letter: 'Ÿá', color: '#e91e63' },  // Pink
            { letter: 'Ÿà', color: '#00acc1' },  // Light Blue
            { letter: 'Ÿä', color: '#7b1fa2' }   // Purple
        ];

        // Piece Shapes (Simplified - max 3 blocks)
        const pieceShapes = [
            // Single block
            [[1]],
            
            // 2-block pieces
            [[1, 1]],
            [[1], [1]],
            
            // 3-block pieces
            [[1, 1, 1]],
            [[1], [1], [1]],
            [[1, 1], [1, 0]],
            [[1, 1], [0, 1]],
            [[1, 0], [1, 1]],
            [[0, 1], [1, 1]]
        ];

        // ===== INITIALIZATION =====
        function initGame() {
            loadGameData();
            createGameBoard();
            generateNewPieces();
            updateDisplay();
            gameRunning = true;
        }

        function loadGameData() {
            // Load settings
            const savedSettings = localStorage.getItem('blastHijaiyahSettings');
            if (savedSettings) {
                gameSettings = { ...gameSettings, ...JSON.parse(savedSettings) };
            }

            // Load level-based modules
            const savedLevelModules = localStorage.getItem('blastHijaiyahLevelModules');
            if (savedLevelModules) {
                levelBasedModules = JSON.parse(savedLevelModules);
            }

            // Load learning modules (legacy)
            const savedModules = localStorage.getItem('blastHijaiyahModules');
            if (savedModules) {
                learningModules = JSON.parse(savedModules);
            }

            // Load learning progress
            const savedProgress = localStorage.getItem('blastHijaiyahLearningProgress');
            if (savedProgress) {
                window.learningProgress = JSON.parse(savedProgress);
            } else {
                window.learningProgress = {};
            }

            // Load achievements
            const savedAchievements = localStorage.getItem('blastHijaiyahAchievements');
            if (savedAchievements) {
                achievements = JSON.parse(savedAchievements);
            }

            // Load unlocked achievements
            const savedUnlocked = localStorage.getItem('blastHijaiyahUnlocked');
            if (savedUnlocked) {
                unlockedAchievements = JSON.parse(savedUnlocked);
            }

            // Load game stats
            const savedStats = localStorage.getItem('blastHijaiyahStats');
            if (savedStats) {
                gameStats = { ...gameStats, ...JSON.parse(savedStats) };
            }

            updateAdminDisplay();
        }

        function createGameBoard() {
            gameBoard = [];
            const boardElement = document.getElementById('gameBoard');
            boardElement.innerHTML = '';

            for (let row = 0; row < GRID_SIZE; row++) {
                gameBoard[row] = [];
                for (let col = 0; col < GRID_SIZE; col++) {
                    gameBoard[row][col] = { filled: false, letter: '', color: '' };
                    
                    const cell = document.createElement('div');
                    cell.className = 'grid-cell';
                    cell.id = `cell-${row}-${col}`;
                    cell.onclick = () => placePieceOnBoard(row, col);
                    boardElement.appendChild(cell);
                }
            }
        }

        function generateNewPieces() {
            currentPieces = [];
            
            for (let i = 0; i < 3; i++) {
                const shapeIndex = Math.floor(Math.random() * pieceShapes.length);
                const letterData = arabicLetters[Math.floor(Math.random() * arabicLetters.length)];
                
                currentPieces.push({
                    shape: pieceShapes[shapeIndex],
                    letter: letterData.letter,
                    color: letterData.color,
                    used: false
                });
            }
            
            renderPieces();
            selectedPieceIndex = -1;
        }

        function renderPieces() {
            for (let i = 0; i < 3; i++) {
                const holder = document.getElementById(`piece${i + 1}`);
                holder.innerHTML = '';
                
                if (currentPieces[i] && !currentPieces[i].used) {
                    const piece = currentPieces[i];
                    const pieceElement = document.createElement('div');
                    pieceElement.className = 'piece';
                    pieceElement.style.gridTemplateColumns = `repeat(${piece.shape[0].length}, 1fr)`;
                    pieceElement.style.gridTemplateRows = `repeat(${piece.shape.length}, 1fr)`;
                    
                    for (let row = 0; row < piece.shape.length; row++) {
                        for (let col = 0; col < piece.shape[row].length; col++) {
                            if (piece.shape[row][col]) {
                                const cell = document.createElement('div');
                                cell.className = 'piece-cell';
                                cell.textContent = piece.letter;
                                cell.style.background = `linear-gradient(135deg, ${piece.color}, ${piece.color}dd)`;
                                pieceElement.appendChild(cell);
                            } else {
                                const cell = document.createElement('div');
                                cell.style.width = '16px';
                                cell.style.height = '16px';
                                pieceElement.appendChild(cell);
                            }
                        }
                    }
                    
                    holder.appendChild(pieceElement);
                    holder.classList.remove('empty');
                } else {
                    holder.classList.add('empty');
                }
            }
        }

        // ===== GAME LOGIC =====
        function selectPiece(index) {
            if (!currentPieces[index] || currentPieces[index].used) return;
            
            // Remove previous selection
            document.querySelectorAll('.piece-holder').forEach(holder => {
                holder.classList.remove('selected');
            });
            
            // Select new piece
            selectedPieceIndex = index;
            document.getElementById(`piece${index + 1}`).classList.add('selected');
            
            // Show possible placements
            highlightPossiblePlacements();
        }

        function highlightPossiblePlacements() {
            // Clear previous highlights
            document.querySelectorAll('.grid-cell').forEach(cell => {
                cell.classList.remove('highlight');
            });
            
            if (selectedPieceIndex === -1) return;
            
            const piece = currentPieces[selectedPieceIndex];
            
            for (let row = 0; row <= GRID_SIZE - piece.shape.length; row++) {
                for (let col = 0; col <= GRID_SIZE - piece.shape[0].length; col++) {
                    if (canPlacePiece(piece, row, col)) {
                        // Highlight this position
                        for (let pRow = 0; pRow < piece.shape.length; pRow++) {
                            for (let pCol = 0; pCol < piece.shape[pRow].length; pCol++) {
                                if (piece.shape[pRow][pCol]) {
                                    const cell = document.getElementById(`cell-${row + pRow}-${col + pCol}`);
                                    cell.classList.add('highlight');
                                }
                            }
                        }
                    }
                }
            }
        }

        function canPlacePiece(piece, startRow, startCol) {
            for (let row = 0; row < piece.shape.length; row++) {
                for (let col = 0; col < piece.shape[row].length; col++) {
                    if (piece.shape[row][col]) {
                        const boardRow = startRow + row;
                        const boardCol = startCol + col;
                        
                        if (boardRow >= GRID_SIZE || boardCol >= GRID_SIZE || 
                            gameBoard[boardRow][boardCol].filled) {
                            return false;
                        }
                    }
                }
            }
            return true;
        }

        function placePieceOnBoard(clickRow, clickCol) {
            if (selectedPieceIndex === -1) return;
            
            const piece = currentPieces[selectedPieceIndex];
            
            // Find the top-left position of the piece relative to click
            let bestRow = clickRow;
            let bestCol = clickCol;
            
            // Try to place piece with clicked cell as part of the piece
            for (let pRow = 0; pRow < piece.shape.length; pRow++) {
                for (let pCol = 0; pCol < piece.shape[pRow].length; pCol++) {
                    if (piece.shape[pRow][pCol]) {
                        const testRow = clickRow - pRow;
                        const testCol = clickCol - pCol;
                        
                        if (testRow >= 0 && testCol >= 0 && canPlacePiece(piece, testRow, testCol)) {
                            bestRow = testRow;
                            bestCol = testCol;
                            break;
                        }
                    }
                }
            }
            
            if (canPlacePiece(piece, bestRow, bestCol)) {
                // Place the piece
                for (let row = 0; row < piece.shape.length; row++) {
                    for (let col = 0; col < piece.shape[row].length; col++) {
                        if (piece.shape[row][col]) {
                            const boardRow = bestRow + row;
                            const boardCol = bestCol + col;
                            gameBoard[boardRow][boardCol] = {
                                filled: true,
                                letter: piece.letter,
                                color: piece.color
                            };
                        }
                    }
                }
                
                // Mark piece as used
                currentPieces[selectedPieceIndex].used = true;
                selectedPieceIndex = -1;
                
                // Update display
                renderBoard();
                renderPieces();
                
                // Clear highlights
                document.querySelectorAll('.grid-cell').forEach(cell => {
                    cell.classList.remove('highlight');
                });
                
                // Update stats
                gameStats.piecesPlaced++;
                
                // Check for line clears
                checkAndClearLines();
                
                // Check for game over first
                if (checkGameOver()) {
                    endGame();
                    return; // Stop processing immediately
                }
                
                // Check if all pieces used (only if game is still running)
                if (gameRunning && currentPieces.every(p => p.used)) {
                    generateNewPieces();
                }
                
                updateDisplay();
                saveGameData();
            }
        }

        function renderBoard() {
            for (let row = 0; row < GRID_SIZE; row++) {
                for (let col = 0; col < GRID_SIZE; col++) {
                    const cell = document.getElementById(`cell-${row}-${col}`);
                    const boardCell = gameBoard[row][col];
                    
                    // Remove all classes first
                    cell.classList.remove('filled');
                    
                    if (boardCell.filled) {
                        cell.classList.add('filled');
                        cell.textContent = boardCell.letter;
                        cell.style.background = `linear-gradient(135deg, ${boardCell.color}, ${boardCell.color}dd)`;
                        cell.style.borderColor = `${boardCell.color}cc`;
                        cell.style.boxShadow = `0 0 15px ${boardCell.color}44`;
                    } else {
                        cell.textContent = '';
                        cell.style.background = '';
                        cell.style.borderColor = '';
                        cell.style.boxShadow = '';
                    }
                }
            }
        }

        function checkAndClearLines() {
            // Don't process line clears if game is over
            if (!gameRunning) return;
            
            const linesToClear = [];
            
            // Check rows
            for (let row = 0; row < GRID_SIZE; row++) {
                if (gameBoard[row].every(cell => cell.filled)) {
                    linesToClear.push({ type: 'row', index: row });
                }
            }
            
            // Check columns
            for (let col = 0; col < GRID_SIZE; col++) {
                let fullColumn = true;
                for (let row = 0; row < GRID_SIZE; row++) {
                    if (!gameBoard[row][col].filled) {
                        fullColumn = false;
                        break;
                    }
                }
                if (fullColumn) {
                    linesToClear.push({ type: 'col', index: col });
                }
            }
            
            if (linesToClear.length > 0) {
                clearLines(linesToClear);
            }
        }

        function clearLines(lines) {
            // First, add clearing animation to the cells that will be cleared
            const cellsToAnimate = [];
            
            lines.forEach(line => {
                if (line.type === 'row') {
                    for (let col = 0; col < GRID_SIZE; col++) {
                        if (gameBoard[line.index][col].filled) {
                            const cell = document.getElementById(`cell-${line.index}-${col}`);
                            cell.classList.add('clearing');
                            cellsToAnimate.push({ row: line.index, col: col });
                        }
                    }
                } else {
                    for (let row = 0; row < GRID_SIZE; row++) {
                        if (gameBoard[row][line.index].filled) {
                            const cell = document.getElementById(`cell-${row}-${line.index}`);
                            cell.classList.add('clearing');
                            cellsToAnimate.push({ row: row, col: line.index });
                        }
                    }
                }
            });
            
            // Wait for animation to complete, then clear the data
            setTimeout(() => {
                // Clear the game data
                lines.forEach(line => {
                    if (line.type === 'row') {
                        for (let col = 0; col < GRID_SIZE; col++) {
                            gameBoard[line.index][col] = { filled: false, letter: '', color: '' };
                        }
                    } else {
                        for (let row = 0; row < GRID_SIZE; row++) {
                            gameBoard[row][line.index] = { filled: false, letter: '', color: '' };
                        }
                    }
                });
                
                // Remove clearing animation and reset cells to empty state
                cellsToAnimate.forEach(pos => {
                    const cell = document.getElementById(`cell-${pos.row}-${pos.col}`);
                    cell.classList.remove('clearing', 'filled');
                    cell.textContent = '';
                    // Reset to default empty cell styling - DON'T override CSS classes
                    cell.style.background = '';
                    cell.style.borderColor = '';
                    cell.style.boxShadow = '';
                });
                
                // Update stats
                const clearedCount = lines.length;
                gameStats.linesCleared += clearedCount;
                gameStats.totalClears++;
                
                // Calculate score
                let baseScore = clearedCount * 100 * gameSettings.scoreMultiplier;
                
                // Combo bonus
                if (clearedCount > 1) {
                    gameStats.comboCount++;
                    baseScore += gameStats.comboCount * gameSettings.comboBonus;
                } else {
                    gameStats.comboCount = 0;
                }
                
                gameStats.score += Math.floor(baseScore);
                
                // Level up check
                gameStats.currentLevel = Math.floor(gameStats.linesCleared / 10) + 1;
                
                // Check achievements
                checkAchievements();
                
                // Check learning trigger (only if game is still running)
                if (gameRunning && gameStats.totalClears % gameSettings.learningTrigger === 0) {
                    showLearningContent();
                }
                
                updateDisplay();
                saveGameData();
            }, 600); // Match the animation duration
        }

        function checkGameOver() {
            // Check if any piece can be placed
            for (let piece of currentPieces) {
                if (piece.used) continue;
                
                for (let row = 0; row <= GRID_SIZE - piece.shape.length; row++) {
                    for (let col = 0; col <= GRID_SIZE - piece.shape[0].length; col++) {
                        if (canPlacePiece(piece, row, col)) {
                            return false;
                        }
                    }
                }
            }
            return true;
        }

        function endGame() {
            gameRunning = false;
            
            // Clear any pending learning/evaluation flags to prevent popups
            window.shouldStartEvaluation = false;
            window.evaluationLevel = null;
            window.currentEvaluationQuestions = null;
            window.currentEvaluationIndex = 0;
            window.evaluationCorrectAnswers = 0;
            window.currentEvaluationLevel = null;
            
            // Close any open learning popups
            document.getElementById('learningPopup').style.display = 'none';
            
            // Show final stats
            const finalStatsHtml = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; text-align: center;">
                    <div><strong>Skor:</strong> ${gameStats.score.toLocaleString()}</div>
                    <div><strong>Level:</strong> ${gameStats.currentLevel}</div>
                    <div><strong>Baris Cleared:</strong> ${gameStats.linesCleared}</div>
                    <div><strong>Max Combo:</strong> ${gameStats.comboCount}</div>
                    <div><strong>Pieces Placed:</strong> ${gameStats.piecesPlaced}</div>
                    <div><strong>Total Clears:</strong> ${gameStats.totalClears}</div>
                </div>
            `;
            
            document.getElementById('finalStats').innerHTML = finalStatsHtml;
            document.getElementById('gameOverPopup').style.display = 'flex';
        }

        function checkAchievements() {
            const newAchievements = [];
            
            achievements.forEach(achievement => {
                if (unlockedAchievements.includes(achievement.id)) return;
                
                let unlocked = false;
                
                switch (achievement.condition) {
                    case 'score':
                        unlocked = gameStats.score >= achievement.target;
                        break;
                    case 'lines':
                        unlocked = gameStats.linesCleared >= achievement.target;
                        break;
                    case 'combo':
                        unlocked = gameStats.comboCount >= achievement.target;
                        break;
                    case 'pieces':
                        unlocked = gameStats.piecesPlaced >= achievement.target;
                        break;
                }
                
                if (unlocked) {
                    unlockedAchievements.push(achievement.id);
                    newAchievements.push(achievement);
                }
            });
            
            if (newAchievements.length > 0) {
                localStorage.setItem('blastHijaiyahUnlocked', JSON.stringify(unlockedAchievements));
                showNewAchievements(newAchievements);
            }
        }

        function showNewAchievements(achievements) {
            // Simple notification for now
            achievements.forEach(achievement => {
                setTimeout(() => {
                    alert(`üèÜ Achievement Unlocked!\n\n${achievement.icon} ${achievement.name}\n${achievement.description}`);
                }, 500);
            });
        }

        // ===== LEARNING SYSTEM =====
        function showLearningContent() {
            // Don't show learning content if game is over
            if (!gameRunning) return;
            
            // Initialize learning progress if not exists
            if (!window.learningProgress) {
                window.learningProgress = {};
            }
            
            // Use the current game level for learning
            let targetLevel = gameStats.currentLevel;
            let currentLevelLetters = levelBasedModules[targetLevel];
            
            // If no letters for current level, check if we need to wait for admin
            if (!currentLevelLetters || currentLevelLetters.length === 0) {
                // Check if this is level 1 or if previous levels exist
                if (targetLevel === 1) {
                    alert('‚ùå Level 1 belum dibuat!\n\nSilakan buka Admin Panel dan buat Level 1 terlebih dahulu.');
                    return;
                } else {
                    // Show waiting popup for next level
                    showWaitingForNextLevel(targetLevel);
                    return;
                }
            }
            
            // Initialize progress for this level
            if (!window.learningProgress[targetLevel]) {
                window.learningProgress[targetLevel] = 0;
            }
            
            // Get current letter index for this level
            const letterIndex = window.learningProgress[targetLevel];
            
            // Check if we've shown all letters in this level
            if (letterIndex >= currentLevelLetters.length) {
                // All letters shown - start evaluation
                window.shouldStartEvaluation = true;
                window.evaluationLevel = targetLevel;
                
                // DON'T reset progress here - let evaluation handle it
                startLevelEvaluation(targetLevel);
                return;
            }
            
            // Show ONLY the current letter (one at a time)
            const currentLetter = currentLevelLetters[letterIndex];
            
            document.getElementById('learningArabic').textContent = currentLetter.arabic;
            document.getElementById('learningTitle').textContent = `üïå Level ${targetLevel} - Belajar Dulu Ya !`;
            document.getElementById('learningMeaning').textContent = `Ikuti Bacaan Ustadz/ah`;
            
            // Hide quiz container for letter display
            document.getElementById('quizContainer').style.display = 'none';
            
            // Increment progress for next time
            window.learningProgress[targetLevel]++;
            
            // Save progress to localStorage
            localStorage.setItem('blastHijaiyahLearningProgress', JSON.stringify(window.learningProgress));
            
            document.getElementById('learningPopup').style.display = 'flex';
        }

        function proceedToNextLevel(nextLevel) {
            // Update game level
            gameStats.currentLevel = nextLevel;
            
            // Reset learning progress for the new level
            if (!window.learningProgress) {
                window.learningProgress = {};
            }
            window.learningProgress[nextLevel] = 0;
            
            // Clear evaluation flags to prevent re-triggering
            window.shouldStartEvaluation = false;
            window.evaluationLevel = null;
            window.currentEvaluationQuestions = null;
            window.currentEvaluationIndex = 0;
            window.evaluationCorrectAnswers = 0;
            window.currentEvaluationLevel = null;
            
            // Save progress
            localStorage.setItem('blastHijaiyahLearningProgress', JSON.stringify(window.learningProgress));
            saveGameData();
            
            // Close popup and continue game
            closeLearningPopup();
            
            // Show level up notification
            setTimeout(() => {
                showLevelUpNotification(nextLevel);
            }, 500);
            
            updateDisplay();
        }

        function showLevelUpNotification(level) {
            const popup = document.createElement('div');
            popup.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: linear-gradient(135deg, rgba(0,0,0,0.8), rgba(44,62,80,0.7));
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 2000;
                backdrop-filter: blur(15px);
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: linear-gradient(135deg, #f39c12 0%, #e67e22 50%, #d35400 100%);
                background-size: 400% 400%;
                animation: gradientShift 8s ease infinite, popupAppear 0.6s ease-out;
                color: white;
                border-radius: 30px;
                padding: 50px;
                max-width: 450px;
                text-align: center;
                box-shadow: 0 30px 80px rgba(0,0,0,0.5), 0 0 50px rgba(243,156,18,0.3);
                border: 3px solid rgba(255,255,255,0.3);
                position: relative;
                overflow: hidden;
            `;
            
            const levelLetters = levelBasedModules[level];
            const lettersList = levelLetters ? levelLetters.map(l => l.arabic).join(' ') : '';
            
            content.innerHTML = `
                <div style="font-size: 5rem; margin-bottom: 25px; animation: pulse 2s ease-in-out infinite;">
                    üöÄ
                </div>
                <h2 style="font-size: 2.5rem; font-weight: 800; margin-bottom: 20px; color: #fff; text-shadow: 0 3px 10px rgba(0,0,0,0.3);">
                    Level Up!
                </h2>
                <div style="background: linear-gradient(135deg, rgba(255,255,255,0.2), rgba(255,255,255,0.1)); border-radius: 20px; padding: 25px; margin: 25px 0; border: 2px solid rgba(255,255,255,0.3);">
                    <div style="font-size: 1.5rem; font-weight: 600; margin-bottom: 15px; color: #fff;">
                        üéØ Sekarang Level ${level}
                    </div>
                    <div style="font-family: 'Scheherazade New', 'Amiri', serif; font-size: 2rem; color: #fff; margin: 15px 0; text-shadow: 0 2px 8px rgba(0,0,0,0.3);">
                        ${lettersList}
                    </div>
                    <div style="font-size: 1.1rem; color: #fff; line-height: 1.6;">
                        Huruf-huruf baru siap dipelajari!<br>
                        Terus main untuk belajar lebih banyak!
                    </div>
                </div>
                <div style="margin-top: 35px;">
                    <button onclick="this.closest('.levelup-popup').remove()" style="background: linear-gradient(135deg, #fff, #f8f9fa); color: #f39c12; border: none; padding: 18px 35px; border-radius: 25px; font-size: 1.3rem; font-weight: 700; cursor: pointer; box-shadow: 0 10px 30px rgba(255,255,255,0.3); border: 2px solid rgba(255,255,255,0.5); transition: all 0.3s ease;">
                        üéÆ Lanjut Main!
                    </button>
                </div>
            `;
            
            popup.appendChild(content);
            popup.className = 'levelup-popup';
            document.body.appendChild(popup);
            
            // Add button hover effect
            const button = content.querySelector('button');
            button.addEventListener('mouseenter', () => {
                button.style.transform = 'translateY(-3px) scale(1.05)';
                button.style.boxShadow = '0 15px 40px rgba(255,255,255,0.4)';
            });
            button.addEventListener('mouseleave', () => {
                button.style.transform = 'translateY(0) scale(1)';
                button.style.boxShadow = '0 10px 30px rgba(255,255,255,0.3)';
            });
            
            // Auto close after 4 seconds
            setTimeout(() => {
                if (document.body.contains(popup)) {
                    popup.remove();
                }
            }, 4000);
            
            // Close on background click
            popup.addEventListener('click', (e) => {
                if (e.target === popup) {
                    popup.remove();
                }
            });
        }

        function showWaitingForNextLevel(level) {
            const popup = document.createElement('div');
            popup.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: linear-gradient(135deg, rgba(0,0,0,0.9), rgba(44,62,80,0.8));
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 2000;
                backdrop-filter: blur(15px);
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: linear-gradient(135deg, #e74c3c 0%, #c0392b 50%, #a93226 100%);
                background-size: 400% 400%;
                animation: gradientShift 8s ease infinite, popupAppear 0.6s ease-out;
                color: white;
                border-radius: 30px;
                padding: 50px;
                max-width: 500px;
                text-align: center;
                box-shadow: 0 30px 80px rgba(0,0,0,0.5), 0 0 50px rgba(231,76,60,0.3);
                border: 3px solid rgba(255,255,255,0.3);
                position: relative;
                overflow: hidden;
            `;
            
            content.innerHTML = `
                <div style="font-size: 4rem; margin-bottom: 20px; animation: pulse 2s ease-in-out infinite;">
                    ‚è≥
                </div>
                <h2 style="font-size: 2.2rem; font-weight: 800; margin-bottom: 25px; color: #fff; text-shadow: 0 3px 10px rgba(0,0,0,0.3);">
                    Level ${level} Belum Siap
                </h2>
                <div style="background: linear-gradient(135deg, rgba(255,255,255,0.2), rgba(255,255,255,0.1)); border-radius: 20px; padding: 25px; margin: 25px 0; border: 2px solid rgba(255,255,255,0.3);">
                    <div style="font-size: 1.3rem; font-weight: 600; margin-bottom: 15px; color: #fff;">
                        üéØ Menunggu Admin
                    </div>
                    <div style="font-size: 1.1rem; line-height: 1.8; color: #fff;">
                        Level ${level} belum dibuat oleh admin.<br>
                        Silakan minta admin untuk:<br><br>
                        1. Buka Admin Panel (‚öôÔ∏è)<br>
                        2. Masukkan Level ${level}<br>
                        3. Tambahkan huruf-huruf baru<br>
                        4. Simpan level
                    </div>
                </div>
                <div style="background: linear-gradient(135deg, rgba(255,193,7,0.3), rgba(255,193,7,0.2)); border-radius: 15px; padding: 20px; margin: 20px 0; border: 2px solid rgba(255,193,7,0.5);">
                    <div style="font-size: 1.1rem; font-weight: 600; color: #fff; margin-bottom: 10px;">
                        üéÆ Sementara Ini
                    </div>
                    <div style="font-size: 1rem; color: #fff;">
                        Kamu bisa lanjut main dengan skor sekarang.<br>
                        Level akan otomatis naik setelah admin membuat level baru!
                    </div>
                </div>
                <div style="display: flex; gap: 15px; margin-top: 35px;">
                    <button onclick="openAdminPanelForLevel(${level})" style="flex: 1; background: linear-gradient(135deg, #f39c12, #e67e22); color: white; border: none; padding: 18px 25px; border-radius: 25px; font-size: 1.1rem; font-weight: 700; cursor: pointer; box-shadow: 0 10px 30px rgba(243,156,18,0.4); border: 2px solid rgba(255,255,255,0.3);">
                        ‚öôÔ∏è Buka Admin
                    </button>
                    <button onclick="continueWithCurrentLevel()" style="flex: 1; background: linear-gradient(135deg, #27ae60, #2ecc71); color: white; border: none; padding: 18px 25px; border-radius: 25px; font-size: 1.1rem; font-weight: 700; cursor: pointer; box-shadow: 0 10px 30px rgba(39,174,96,0.4); border: 2px solid rgba(255,255,255,0.3);">
                        üéÆ Lanjut Main
                    </button>
                </div>
            `;
            
            popup.appendChild(content);
            popup.className = 'waiting-level-popup';
            document.body.appendChild(popup);
            
            // Add global functions for buttons
            window.openAdminPanelForLevel = function(level) {
                popup.remove();
                
                // Pre-fill the admin form with the needed level
                document.getElementById('gameLevel').value = level;
                document.getElementById('levelName').value = `Level ${level}`;
                
                // Show password popup to open admin
                document.getElementById('passwordPopup').style.display = 'flex';
                document.getElementById('adminPassword').focus();
            };
            
            window.continueWithCurrentLevel = function() {
                popup.remove();
                // Just close and continue with current level
                // The game will stay at current level until next level is created
            };
            
            // Close on background click
            popup.addEventListener('click', (e) => {
                if (e.target === popup) {
                    popup.remove();
                }
            });
        }

        function generateLevelBasedQuiz(levelOverride = null) {
            const targetLevel = levelOverride || gameStats.currentLevel;
            const currentLevelModules = levelBasedModules[targetLevel];
            
            if (!currentLevelModules || currentLevelModules.length === 0) {
                // Find any available level
                const availableLevels = Object.keys(levelBasedModules).filter(level => levelBasedModules[level].length > 0);
                if (availableLevels.length === 0) {
                    document.getElementById('quizContainer').style.display = 'none';
                    return;
                }
                
                // Use first available level
                const firstLevel = availableLevels[0];
                const modules = levelBasedModules[firstLevel];
                const allLetters = modules.map(m => ({ arabic: m.arabic, title: m.title }));
                
                generateQuizFromLetters(allLetters, parseInt(firstLevel));
                return;
            }
            
            const allLetters = currentLevelModules.map(m => ({ arabic: m.arabic, title: m.title }));
            generateQuizFromLetters(allLetters, targetLevel);
        }

        function generateQuizFromLetters(allLetters, level) {
            if (allLetters.length < 2) {
                document.getElementById('quizContainer').innerHTML = `
                    <div style="text-align: center; color: #e74c3c;">
                        ‚ùå Level ${level} membutuhkan minimal 2 huruf untuk quiz!
                    </div>
                `;
                return;
            }
            
            // Generate 15 random questions
            const quizQuestions = [];
            
            for (let i = 0; i < 15; i++) {
                const correctLetter = allLetters[Math.floor(Math.random() * allLetters.length)];
                
                // Create wrong options from other letters in the same level
                const wrongOptions = allLetters.filter(l => l.arabic !== correctLetter.arabic);
                const shuffledWrong = wrongOptions.sort(() => Math.random() - 0.5);
                
                // Create options (1 correct + 1-2 wrong, max 3 total)
                const maxWrong = Math.min(2, wrongOptions.length);
                const numWrong = Math.random() < 0.5 ? 1 : maxWrong; // Random between 1 or 2 wrong options
                const options = [correctLetter];
                
                for (let j = 0; j < numWrong; j++) {
                    options.push(shuffledWrong[j]);
                }
                
                // Shuffle options
                const shuffledOptions = options.sort(() => Math.random() - 0.5);
                const correctIndex = shuffledOptions.findIndex(opt => opt.arabic === correctLetter.arabic);
                
                quizQuestions.push({
                    question: `Huruf apa ini: ${correctLetter.arabic}?`,
                    options: shuffledOptions.map(opt => opt.title),
                    correct: correctIndex,
                    arabic: correctLetter.arabic
                });
            }
            
            // Store quiz questions for the session
            window.currentQuizQuestions = quizQuestions;
            window.currentQuizIndex = 0;
            window.correctAnswers = 0;
            window.currentQuizLevel = level;
            
            // Show first question
            showNextQuizQuestion();
        }

        function showNextQuizQuestion() {
            if (window.currentQuizIndex >= window.currentQuizQuestions.length) {
                // Quiz completed
                showQuizResults();
                return;
            }
            
            const question = window.currentQuizQuestions[window.currentQuizIndex];
            
            document.getElementById('quizContainer').style.display = 'block';
            document.getElementById('quizQuestion').innerHTML = `
                <div style="text-align: center; margin-bottom: 15px;">
                    <div style="font-family: 'Scheherazade New', 'Amiri', serif; font-size: 4rem; color: #2c3e50; margin-bottom: 10px;">${question.arabic}</div>
                    <div style="font-size: 1.1rem;">${question.question}</div>
                    <div style="font-size: 0.9rem; color: #7f8c8d; margin-top: 5px;">Soal ${window.currentQuizIndex + 1} dari ${window.currentQuizQuestions.length}</div>
                </div>
            `;
            
            const optionsContainer = document.getElementById('quizOptions');
            optionsContainer.innerHTML = '';
            
            question.options.forEach((option, index) => {
                const optionElement = document.createElement('div');
                optionElement.className = 'quiz-option';
                optionElement.textContent = `${index + 1}. ${option}`;
                optionElement.onclick = () => answerLevelQuiz(index, question.correct, optionElement);
                optionsContainer.appendChild(optionElement);
            });
        }

        function answerLevelQuiz(selected, correct, element) {
            // Disable all options
            document.querySelectorAll('.quiz-option').forEach(opt => {
                opt.onclick = null;
                opt.style.cursor = 'default';
            });
            
            if (selected === correct) {
                element.classList.add('correct');
                window.correctAnswers++;
                gameStats.score += 100; // Bonus for correct answer
            } else {
                element.classList.add('wrong');
                document.querySelectorAll('.quiz-option')[correct].classList.add('correct');
            }
            
            // Move to next question after delay
            setTimeout(() => {
                window.currentQuizIndex++;
                showNextQuizQuestion();
            }, 1500);
            
            updateDisplay();
        }

        function showQuizResults() {
            const totalQuestions = window.currentQuizQuestions.length;
            const correctCount = window.correctAnswers;
            const percentage = Math.round((correctCount / totalQuestions) * 100);
            const quizLevel = window.currentQuizLevel || gameStats.currentLevel;
            
            // Calculate bonus score
            let bonusScore = 0;
            if (percentage >= 80) bonusScore = 1000;
            else if (percentage >= 60) bonusScore = 500;
            else if (percentage >= 40) bonusScore = 200;
            
            gameStats.score += bonusScore;
            
            document.getElementById('quizContainer').innerHTML = `
                <div style="text-align: center;">
                    <h3 style="color: #2c3e50; margin-bottom: 20px;">üéØ Hasil Quiz Level ${quizLevel}</h3>
                    <div style="font-size: 2rem; margin: 20px 0; color: ${percentage >= 60 ? '#27ae60' : '#e74c3c'};">
                        ${correctCount}/${totalQuestions} Benar (${percentage}%)
                    </div>
                    <div style="background: linear-gradient(135deg, rgba(46,204,113,0.2), rgba(46,204,113,0.1)); padding: 15px; border-radius: 10px; margin: 15px 0;">
                        <div style="color: #27ae60; font-weight: 600;">üí∞ Bonus Score: +${bonusScore}</div>
                    </div>
                    <div style="font-size: 0.9rem; color: #7f8c8d; margin-top: 15px;">
                        ${percentage >= 80 ? 'üåü Excellent! Kamu menguasai huruf-huruf ini!' : 
                          percentage >= 60 ? 'üëç Good job! Terus berlatih!' : 
                          'üí™ Keep practicing! Kamu pasti bisa lebih baik!'}
                    </div>
                </div>
            `;
            
            updateDisplay();
        }



        function continueCurrentLevel() {
            // Clear all evaluation flags to prevent re-triggering
            window.shouldStartEvaluation = false;
            window.evaluationLevel = null;
            window.currentEvaluationQuestions = null;
            window.currentEvaluationIndex = 0;
            window.evaluationCorrectAnswers = 0;
            window.currentEvaluationLevel = null;
            
            // Close popup and continue game at current level
            closeLearningPopup();
        }

        function closeLearningPopup() {
            document.getElementById('learningPopup').style.display = 'none';
            
            // Reset buttons to default
            document.getElementById('evaluationButtons').innerHTML = `
                <button class="btn" onclick="closeLearningPopup()" style="background: linear-gradient(135deg, #27ae60, #2ecc71); font-size: 1.2rem; padding: 18px 35px; box-shadow: 0 10px 30px rgba(39,174,96,0.4); border: 2px solid rgba(255,255,255,0.3);">‚úÖ Mengerti!</button>
            `;
            
            // Check if we should start evaluation after closing
            if (window.shouldStartEvaluation) {
                window.shouldStartEvaluation = false;
                const level = window.evaluationLevel || gameStats.currentLevel;
                
                setTimeout(() => {
                    startLevelEvaluation(level);
                }, 500);
            }
        }

        function startLevelEvaluation(level) {
            // Don't start evaluation if game is over
            if (!gameRunning) return;
            
            const currentLevelModules = levelBasedModules[level];
            
            if (!currentLevelModules || currentLevelModules.length === 0) {
                alert('‚ùå Tidak ada huruf untuk evaluasi di level ini!');
                return;
            }
            
            // Create evaluation questions with progressive difficulty
            const evaluationQuestions = [];
            const allLetters = currentLevelModules.map(m => ({ arabic: m.arabic, title: m.title }));
            
            // Generate 15 questions with progressive difficulty
            for (let i = 0; i < 15; i++) {
                let numOptions;
                
                // Progressive difficulty: 1-5 questions = 1 option, 6-10 = 2 options, 11-15 = 3 options
                if (i < 5) {
                    numOptions = 1; // Only correct answer (very easy)
                } else if (i < 10) {
                    numOptions = 2; // 1 correct + 1 wrong
                } else {
                    numOptions = 3; // 1 correct + 2 wrong
                }
                
                const correctLetter = allLetters[Math.floor(Math.random() * allLetters.length)];
                const wrongOptions = allLetters.filter(l => l.arabic !== correctLetter.arabic);
                
                // Create options array
                const options = [correctLetter];
                
                // Add wrong options if needed and available
                const numWrongToAdd = Math.min(numOptions - 1, wrongOptions.length);
                const shuffledWrong = wrongOptions.sort(() => Math.random() - 0.5);
                
                for (let j = 0; j < numWrongToAdd; j++) {
                    options.push(shuffledWrong[j]);
                }
                
                // Shuffle all options
                const shuffledOptions = options.sort(() => Math.random() - 0.5);
                const correctIndex = shuffledOptions.findIndex(opt => opt.arabic === correctLetter.arabic);
                
                evaluationQuestions.push({
                    question: `Huruf apa ini: ${correctLetter.arabic}?`,
                    options: shuffledOptions.map(opt => opt.title),
                    correct: correctIndex,
                    arabic: correctLetter.arabic,
                    difficulty: i < 5 ? 'Mudah' : i < 10 ? 'Sedang' : 'Sulit'
                });
            }
            
            // Store evaluation data
            window.currentEvaluationQuestions = evaluationQuestions;
            window.currentEvaluationIndex = 0;
            window.evaluationCorrectAnswers = 0;
            window.currentEvaluationLevel = level;
            
            // Show evaluation popup
            showEvaluationQuestion();
        }

        function showEvaluationQuestion() {
            if (window.currentEvaluationIndex >= window.currentEvaluationQuestions.length) {
                // Evaluation completed
                showEvaluationResults();
                return;
            }
            
            const question = window.currentEvaluationQuestions[window.currentEvaluationIndex];
            const totalQuestions = window.currentEvaluationQuestions.length;
            const currentNum = window.currentEvaluationIndex + 1;
            
            // Update popup content for evaluation
            document.getElementById('learningArabic').textContent = question.arabic;
            document.getElementById('learningTitle').textContent = `üìù Evaluasi Level ${window.currentEvaluationLevel}`;
            document.getElementById('learningMeaning').innerHTML = `
                <div style="text-align: center;">
                    <div style="font-size: 1.3rem; color: #2c3e50; margin-bottom: 20px;">
                        Bacakan huruf ini dengan benar!
                    </div>
                    <div style="background: linear-gradient(135deg, rgba(52,152,219,0.2), rgba(52,152,219,0.1)); padding: 20px; border-radius: 15px; border: 2px solid rgba(52,152,219,0.3);">
                        <div style="font-size: 1.1rem; color: #2c3e50; margin-bottom: 10px;">
                            üìä Progress: ${currentNum} dari ${totalQuestions}
                        </div>
                        <div style="font-size: 1rem; color: #7f8c8d;">
                            ‚úÖ Sudah benar: ${window.evaluationCorrectAnswers} huruf
                        </div>
                    </div>
                </div>
            `;
            
            // Hide quiz container for reading evaluation
            document.getElementById('quizContainer').style.display = 'none';
            
            // Update buttons for evaluation
            document.getElementById('evaluationButtons').innerHTML = `
                <div style="display: flex; gap: 20px; justify-content: center;">
                    <button class="btn" onclick="answerEvaluationReading(true)" style="background: linear-gradient(135deg, #27ae60, #2ecc71); font-size: 1.2rem; padding: 18px 35px; box-shadow: 0 10px 30px rgba(39,174,96,0.4); border: 2px solid rgba(255,255,255,0.3); flex: 1;">
                        ‚úÖ Benar
                    </button>
                    <button class="btn" onclick="answerEvaluationReading(false)" style="background: linear-gradient(135deg, #e74c3c, #c0392b); font-size: 1.2rem; padding: 18px 35px; box-shadow: 0 10px 30px rgba(231,76,60,0.4); border: 2px solid rgba(255,255,255,0.3); flex: 1;">
                        ‚ùå Salah
                    </button>
                </div>
            `;
            
            // Show popup
            document.getElementById('learningPopup').style.display = 'flex';
        }

        function answerEvaluationQuestion(selected, correct, element) {
            // Disable all options
            document.querySelectorAll('.quiz-option').forEach(opt => {
                opt.onclick = null;
                opt.style.cursor = 'default';
            });
            
            if (selected === correct) {
                element.classList.add('correct');
                window.evaluationCorrectAnswers++;
                gameStats.score += 150; // Higher bonus for evaluation
            } else {
                element.classList.add('wrong');
                document.querySelectorAll('.quiz-option')[correct].classList.add('correct');
            }
            
            // Move to next question after delay
            setTimeout(() => {
                window.currentEvaluationIndex++;
                showEvaluationQuestion();
            }, 1500);
            
            updateDisplay();
        }

        function answerEvaluationReading(isCorrect) {
            // Disable buttons
            const buttons = document.querySelectorAll('#evaluationButtons button');
            buttons.forEach(btn => {
                btn.onclick = null;
                btn.style.cursor = 'default';
                btn.style.opacity = '0.6';
            });
            
            if (isCorrect) {
                window.evaluationCorrectAnswers++;
                gameStats.score += 150; // Bonus for correct reading
                
                // Show positive feedback
                document.getElementById('learningMeaning').innerHTML = `
                    <div style="text-align: center;">
                        <div style="font-size: 1.5rem; color: #27ae60; margin-bottom: 20px;">
                            üéâ Bagus! Bacaan benar!
                        </div>
                        <div style="background: linear-gradient(135deg, rgba(46,204,113,0.2), rgba(46,204,113,0.1)); padding: 20px; border-radius: 15px; border: 2px solid rgba(46,204,113,0.3);">
                            <div style="font-size: 1.1rem; color: #2c3e50; margin-bottom: 10px;">
                                üìä Progress: ${window.currentEvaluationIndex + 1} dari ${window.currentEvaluationQuestions.length}
                            </div>
                            <div style="font-size: 1rem; color: #27ae60;">
                                ‚úÖ Sudah benar: ${window.evaluationCorrectAnswers} huruf
                            </div>
                        </div>
                    </div>
                `;
            } else {
                // Show the correct reading
                const currentQuestion = window.currentEvaluationQuestions[window.currentEvaluationIndex];
                const correctReading = currentQuestion.options[currentQuestion.correct];
                
                document.getElementById('learningMeaning').innerHTML = `
                    <div style="text-align: center;">
                        <div style="font-size: 1.3rem; color: #e74c3c; margin-bottom: 15px;">
                            üìö Bacaan yang benar:
                        </div>
                        <div style="background: linear-gradient(135deg, rgba(52,152,219,0.2), rgba(52,152,219,0.1)); padding: 20px; border-radius: 15px; border: 2px solid rgba(52,152,219,0.3); margin-bottom: 15px;">
                            <div style="font-size: 1.5rem; color: #2c3e50; font-weight: 700;">
                                "${correctReading}"
                            </div>
                        </div>
                        <div style="background: linear-gradient(135deg, rgba(231,76,60,0.2), rgba(231,76,60,0.1)); padding: 15px; border-radius: 10px; border: 2px solid rgba(231,76,60,0.3);">
                            <div style="font-size: 1rem; color: #2c3e50;">
                                üìä Progress: ${window.currentEvaluationIndex + 1} dari ${window.currentEvaluationQuestions.length} | ‚úÖ Benar: ${window.evaluationCorrectAnswers}
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Move to next question after delay
            setTimeout(() => {
                window.currentEvaluationIndex++;
                showEvaluationQuestion();
            }, 2000);
            
            updateDisplay();
        }

        function showEvaluationResults() {
            const totalQuestions = window.currentEvaluationQuestions.length;
            const correctCount = window.evaluationCorrectAnswers;
            const percentage = Math.round((correctCount / totalQuestions) * 100);
            const level = window.currentEvaluationLevel;
            
            // Calculate bonus score based on performance
            let bonusScore = 0;
            let grade = '';
            let message = '';
            
            if (percentage >= 90) {
                bonusScore = 2000;
                grade = 'A+';
                message = 'üåü Luar biasa! Kamu menguasai semua huruf dengan sempurna!';
            } else if (percentage >= 80) {
                bonusScore = 1500;
                grade = 'A';
                message = 'üéâ Excellent! Pemahaman kamu sangat baik!';
            } else if (percentage >= 70) {
                bonusScore = 1000;
                grade = 'B+';
                message = 'üëç Good job! Kamu sudah memahami sebagian besar huruf!';
            } else if (percentage >= 60) {
                bonusScore = 500;
                grade = 'B';
                message = 'üëå Cukup baik! Terus berlatih untuk hasil yang lebih baik!';
            } else if (percentage >= 50) {
                bonusScore = 200;
                grade = 'C';
                message = 'üí™ Keep trying! Kamu perlu lebih banyak latihan!';
            } else {
                bonusScore = 0;
                grade = 'D';
                message = 'üìö Jangan menyerah! Ulangi pembelajaran dan coba lagi!';
            }
            
            gameStats.score += bonusScore;
            
            // Check for level progression
            const nextLevel = level + 1;
            const hasNextLevel = levelBasedModules[nextLevel] && levelBasedModules[nextLevel].length > 0;
            
            // Clear evaluation state to prevent re-triggering
            window.shouldStartEvaluation = false;
            window.evaluationLevel = null;
            
            // Update popup content for results
            document.getElementById('learningArabic').textContent = grade;
            document.getElementById('learningTitle').textContent = `üìä Hasil Evaluasi Level ${level}`;
            document.getElementById('learningMeaning').innerHTML = `
                <div style="text-align: center;">
                    <div style="font-size: 2rem; margin: 20px 0; color: ${percentage >= 70 ? '#27ae60' : percentage >= 50 ? '#f39c12' : '#e74c3c'};">
                        ${correctCount}/${totalQuestions} Benar (${percentage}%)
                    </div>
                    <div style="background: linear-gradient(135deg, rgba(46,204,113,0.2), rgba(46,204,113,0.1)); padding: 20px; border-radius: 15px; margin: 20px 0; border: 2px solid rgba(46,204,113,0.3);">
                        <div style="color: #27ae60; font-weight: 600; font-size: 1.2rem; margin-bottom: 10px;">üí∞ Bonus Score: +${bonusScore}</div>
                        <div style="color: #2c3e50; font-size: 1rem;">${message}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, rgba(52,152,219,0.2), rgba(52,152,219,0.1)); padding: 15px; border-radius: 10px; border: 2px solid rgba(52,152,219,0.3);">
                        <div style="color: #2c3e50; font-size: 0.9rem;">
                            üìà Tingkat Kesulitan:<br>
                            ‚Ä¢ Soal 1-5: Mudah (1 pilihan)<br>
                            ‚Ä¢ Soal 6-10: Sedang (2 pilihan)<br>
                            ‚Ä¢ Soal 11-15: Sulit (3 pilihan)
                        </div>
                    </div>
                    ${hasNextLevel ? `
                        <div style="background: linear-gradient(135deg, rgba(255,193,7,0.2), rgba(255,193,7,0.1)); padding: 20px; border-radius: 15px; margin: 20px 0; border: 2px solid rgba(255,193,7,0.3);">
                            <div style="color: #f39c12; font-weight: 600; font-size: 1.2rem; margin-bottom: 10px;">üéâ Level Selesai!</div>
                            <div style="color: #2c3e50; font-size: 1rem;">Siap naik ke Level ${nextLevel}? Huruf baru menanti!</div>
                        </div>
                    ` : `
                        <div style="background: linear-gradient(135deg, rgba(231,76,60,0.2), rgba(231,76,60,0.1)); padding: 20px; border-radius: 15px; margin: 20px 0; border: 2px solid rgba(231,76,60,0.3);">
                            <div style="color: #e74c3c; font-weight: 600; font-size: 1.2rem; margin-bottom: 10px;">‚è≥ Level ${nextLevel} Belum Siap</div>
                            <div style="color: #2c3e50; font-size: 1rem;">Menunggu admin membuat level selanjutnya...</div>
                        </div>
                    `}
                </div>
            `;
            
            // Update buttons based on level progression
            document.getElementById('evaluationButtons').innerHTML = hasNextLevel ? `
                <div style="display: flex; gap: 15px; justify-content: center;">
                    <button onclick="proceedToNextLevel(${nextLevel})" style="flex: 1; background: linear-gradient(135deg, #f39c12, #e67e22); color: white; border: none; padding: 18px 25px; border-radius: 25px; font-size: 1.2rem; font-weight: 700; cursor: pointer; box-shadow: 0 10px 30px rgba(243,156,18,0.4); border: 2px solid rgba(255,255,255,0.3);">
                        üöÄ Lanjut Level ${nextLevel}
                    </button>
                    <button onclick="continueCurrentLevel()" style="flex: 1; background: linear-gradient(135deg, #27ae60, #2ecc71); color: white; border: none; padding: 18px 25px; border-radius: 25px; font-size: 1.2rem; font-weight: 700; cursor: pointer; box-shadow: 0 10px 30px rgba(39,174,96,0.4); border: 2px solid rgba(255,255,255,0.3);">
                        ‚úÖ Lanjut Main
                    </button>
                </div>
            ` : `
                <button onclick="showWaitingForNextLevel(${nextLevel})" style="background: linear-gradient(135deg, #e74c3c, #c0392b); color: white; border: none; padding: 18px 35px; border-radius: 25px; font-size: 1.2rem; font-weight: 700; cursor: pointer; box-shadow: 0 10px 30px rgba(231,76,60,0.4); border: 2px solid rgba(255,255,255,0.3); width: 100%;">
                    ‚è≥ Tunggu Level ${nextLevel}
                </button>
            `;
            
            // Hide quiz container
            document.getElementById('quizContainer').style.display = 'none';
            
            updateDisplay();
        }

        // ===== ADMIN FUNCTIONS =====
        function toggleAdmin() {
            const adminPanel = document.getElementById('adminPanel');
            
            if (adminPanel.classList.contains('open')) {
                // Close admin panel and hide password popup
                adminPanel.classList.remove('open');
                document.getElementById('passwordPopup').style.display = 'none';
                document.getElementById('adminPassword').value = '';
                document.getElementById('passwordError').style.display = 'none';
            } else {
                // Show password popup to open admin panel
                document.getElementById('passwordPopup').style.display = 'flex';
                document.getElementById('adminPassword').value = '';
                document.getElementById('passwordError').style.display = 'none';
                
                // Focus on password input after a short delay
                setTimeout(() => {
                    document.getElementById('adminPassword').focus();
                }, 300);
            }
        }

        function checkAdminPassword() {
            const password = document.getElementById('adminPassword').value;
            const correctPassword = 'blast';
            
            if (password === correctPassword) {
                // Correct password - open admin panel
                document.getElementById('passwordPopup').style.display = 'none';
                document.getElementById('adminPanel').classList.add('open');
                document.getElementById('adminPassword').value = '';
                document.getElementById('passwordError').style.display = 'none';
            } else {
                // Wrong password - show error
                document.getElementById('passwordError').style.display = 'block';
                document.getElementById('adminPassword').value = '';
                document.getElementById('adminPassword').focus();
                
                // Add shake animation to the popup
                const popup = document.getElementById('passwordPopup').querySelector('.learning-content');
                popup.style.animation = 'none';
                setTimeout(() => {
                    popup.style.animation = 'popupAppear 0.6s ease-out, shake 0.5s ease-in-out';
                }, 10);
            }
        }

        function closePasswordPopup() {
            document.getElementById('passwordPopup').style.display = 'none';
            document.getElementById('adminPassword').value = '';
            document.getElementById('passwordError').style.display = 'none';
        }

        function updateAdminDisplay() {
            // Update game settings display
            const learningTriggerEl = document.getElementById('learningTrigger');
            const scoreMultiplierEl = document.getElementById('scoreMultiplier');
            const comboBonusEl = document.getElementById('comboBonus');
            
            if (learningTriggerEl) {
                learningTriggerEl.value = gameSettings.learningTrigger;
                document.getElementById('learningTriggerValue').textContent = gameSettings.learningTrigger;
            }
            
            if (scoreMultiplierEl) {
                scoreMultiplierEl.value = gameSettings.scoreMultiplier;
                document.getElementById('scoreMultiplierValue').textContent = gameSettings.scoreMultiplier + 'x';
            }
            
            if (comboBonusEl) {
                comboBonusEl.value = gameSettings.comboBonus;
                document.getElementById('comboBonusValue').textContent = gameSettings.comboBonus;
            }
            
            // Add event listeners for range inputs
            if (learningTriggerEl) {
                learningTriggerEl.oninput = function() {
                    document.getElementById('learningTriggerValue').textContent = this.value;
                };
            }
            
            if (scoreMultiplierEl) {
                scoreMultiplierEl.oninput = function() {
                    document.getElementById('scoreMultiplierValue').textContent = this.value + 'x';
                };
            }
            
            if (comboBonusEl) {
                comboBonusEl.oninput = function() {
                    document.getElementById('comboBonusValue').textContent = this.value;
                };
            }
        }

        function saveGameSettings() {
            gameSettings.learningTrigger = parseInt(document.getElementById('learningTrigger').value);
            gameSettings.scoreMultiplier = parseFloat(document.getElementById('scoreMultiplier').value);
            gameSettings.comboBonus = parseInt(document.getElementById('comboBonus').value);
            
            localStorage.setItem('blastHijaiyahSettings', JSON.stringify(gameSettings));
            alert('‚úÖ Game settings berhasil disimpan!');
        }

        function saveLevelContent() {
            const level = parseInt(document.getElementById('gameLevel').value);
            const levelName = document.getElementById('levelName').value.trim();
            const lettersInput = document.getElementById('levelLetters').value.trim();
            
            if (!level || !lettersInput) {
                alert('‚ùå Level dan huruf-huruf wajib diisi!');
                return;
            }
            
            // Parse letters from input - split by comma and clean each letter
            const letters = lettersInput.split(',')
                .map(letter => letter.trim())
                .filter(letter => letter.length > 0);
            
            if (letters.length === 0) {
                alert('‚ùå Minimal masukkan 1 huruf!\n\nContoh: ÿß, ÿ®, ÿ™');
                return;
            }
            
            // Validate that we have actual Arabic letters
            const validLetters = letters.filter(letter => letter.length > 0);
            
            if (validLetters.length === 0) {
                alert('‚ùå Tidak ada huruf valid yang ditemukan!\n\nPastikan format: ÿß, ÿ®, ÿ™, ÿ´');
                return;
            }
            
            // Create individual modules for each letter (one letter per module)
            const modules = validLetters.map((letter, index) => ({
                title: `Huruf ${letter}`,
                arabic: letter,
                meaning: `Ini adalah huruf "${letter}"`
            }));
            
            levelBasedModules[level] = modules;
            localStorage.setItem('blastHijaiyahLevelModules', JSON.stringify(levelBasedModules));
            
            // Reset learning progress for this level to ensure fresh start
            if (!window.learningProgress) {
                window.learningProgress = {};
            }
            window.learningProgress[level] = 0;
            localStorage.setItem('blastHijaiyahLearningProgress', JSON.stringify(window.learningProgress));
            
            // Clear form
            document.getElementById('gameLevel').value = '';
            document.getElementById('levelName').value = '';
            document.getElementById('levelLetters').value = '';
            
            alert(`‚úÖ Level ${level} berhasil disimpan!\n\nüìö Detail:\n‚Ä¢ Total huruf: ${validLetters.length} huruf\n‚Ä¢ Huruf yang disimpan: ${validLetters.join(', ')}\n‚Ä¢ Sistem: 1 huruf per popup (${validLetters.length} popup)\n‚Ä¢ Setelah ${validLetters.length} popup: Evaluasi 15 soal\n\nüéÆ Sekarang coba main dan lihat popup pembelajaran!\n\nüìã Urutan popup:\n${validLetters.map((letter, i) => `${i + 1}. Huruf ${letter}`).join('\n')}\n${validLetters.length + 1}. Evaluasi Quiz`);
        }

        function loadLevelForEdit() {
            // Show available levels first
            const availableLevels = Object.keys(levelBasedModules).sort((a, b) => parseInt(a) - parseInt(b));
            
            if (availableLevels.length === 0) {
                alert('‚ùå Belum ada level yang dibuat!\n\nSilakan buat level pertama terlebih dahulu.');
                return;
            }
            
            // Create a nice popup to select level
            const popup = document.createElement('div');
            popup.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 2000;
                backdrop-filter: blur(10px);
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: linear-gradient(135deg, rgba(255,255,255,0.95), rgba(255,255,255,0.85));
                color: #333;
                border-radius: 25px;
                padding: 40px;
                max-width: 600px;
                max-height: 80vh;
                overflow-y: auto;
                box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            `;
            
            let levelsHtml = '<h2 style="text-align: center; margin-bottom: 30px; color: #2c3e50;">‚úèÔ∏è Pilih Level untuk Diedit</h2>';
            
            availableLevels.forEach(level => {
                const modules = levelBasedModules[level];
                const letters = modules.map(m => m.arabic).join(', ');
                levelsHtml += `
                    <div onclick="editLevel(${level})" style="margin-bottom: 15px; background: linear-gradient(135deg, rgba(52,152,219,0.1), rgba(52,152,219,0.05)); border-radius: 15px; padding: 20px; border: 2px solid rgba(52,152,219,0.2); cursor: pointer; transition: all 0.3s ease;" 
                         onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 25px rgba(52,152,219,0.3)'"
                         onmouseout="this.style.transform=''; this.style.boxShadow=''">
                        <h3 style="color: #2c3e50; margin-bottom: 10px;">üéØ Level ${level}</h3>
                        <div style="font-family: 'Scheherazade New', 'Amiri', serif; font-size: 1.5rem; color: #2c3e50; margin: 10px 0; text-align: center;">${letters}</div>
                        <div style="text-align: center; font-size: 0.9rem; color: #7f8c8d;">
                            üìä ${modules.length} huruf | üëÜ Klik untuk edit
                        </div>
                    </div>
                `;
            });
            
            levelsHtml += `
                <div style="text-align: center; margin-top: 30px;">
                    <button onclick="this.closest('.edit-popup').remove()" style="background: linear-gradient(135deg, #95a5a6, #7f8c8d); color: white; border: none; padding: 15px 30px; border-radius: 25px; font-size: 1rem; font-weight: 600; cursor: pointer; box-shadow: 0 8px 25px rgba(149,165,166,0.3);">
                        ‚ùå Batal
                    </button>
                </div>
            `;
            
            content.innerHTML = levelsHtml;
            popup.appendChild(content);
            popup.className = 'edit-popup';
            document.body.appendChild(popup);
            
            // Add global editLevel function
            window.editLevel = function(level) {
                const modules = levelBasedModules[level];
                const letters = modules.map(m => m.arabic).join(', ');
                
                // Fill the form with existing data
                document.getElementById('gameLevel').value = level;
                document.getElementById('levelName').value = `Level ${level}`;
                document.getElementById('levelLetters').value = letters;
                
                // Close popup
                popup.remove();
                
                // Close admin panel temporarily to show the form better
                const adminPanel = document.getElementById('adminPanel');
                const wasOpen = adminPanel.classList.contains('open');
                if (wasOpen) {
                    adminPanel.classList.remove('open');
                }
                
                // Scroll to the form and highlight it
                setTimeout(() => {
                    if (wasOpen) {
                        adminPanel.classList.add('open');
                    }
                    
                    document.getElementById('gameLevel').scrollIntoView({ behavior: 'smooth' });
                    
                    // Highlight the form briefly
                    const levelSection = document.getElementById('gameLevel').closest('.admin-section');
                    const originalBorder = levelSection.style.border;
                    const originalBoxShadow = levelSection.style.boxShadow;
                    
                    levelSection.style.border = '3px solid #ffd700';
                    levelSection.style.boxShadow = '0 0 20px rgba(255,215,0,0.5)';
                    
                    setTimeout(() => {
                        levelSection.style.border = originalBorder;
                        levelSection.style.boxShadow = originalBoxShadow;
                    }, 3000);
                    
                    alert(`‚úÖ Level ${level} berhasil dimuat untuk diedit!\n\nüìù Data yang dimuat:\n‚Ä¢ Level: ${level}\n‚Ä¢ Huruf: ${letters}\n‚Ä¢ Total: ${modules.length} huruf\n\n‚úèÔ∏è Ubah huruf-huruf di textarea lalu klik "üíæ Simpan Level" untuk menyimpan perubahan.`);
                }, 500);
            };
            
            popup.addEventListener('click', (e) => {
                if (e.target === popup) {
                    popup.remove();
                }
            });
        }

        function showAllLevels() {
            if (Object.keys(levelBasedModules).length === 0) {
                alert('‚ùå Belum ada level yang dibuat!\n\nSilakan buat level pertama dengan:\n1. Masukkan nomor level\n2. Masukkan huruf-huruf dipisah koma\n3. Klik Simpan Level');
                return;
            }
            
            const popup = document.createElement('div');
            popup.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 2000;
                backdrop-filter: blur(10px);
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: linear-gradient(135deg, rgba(255,255,255,0.95), rgba(255,255,255,0.85));
                color: #333;
                border-radius: 25px;
                padding: 40px;
                max-width: 800px;
                max-height: 80vh;
                overflow-y: auto;
                box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            `;
            
            let levelsHtml = '<h2 style="text-align: center; margin-bottom: 30px; color: #2c3e50;">üìö Semua Level yang Sudah Dibuat</h2>';
            
            Object.keys(levelBasedModules).sort((a, b) => parseInt(a) - parseInt(b)).forEach(level => {
                const modules = levelBasedModules[level];
                levelsHtml += `
                    <div style="margin-bottom: 25px; background: linear-gradient(135deg, rgba(52,152,219,0.1), rgba(52,152,219,0.05)); border-radius: 15px; padding: 20px; border: 2px solid rgba(52,152,219,0.2);">
                        <h3 style="color: #2c3e50; margin-bottom: 15px; text-align: center;">üéØ Level ${level}</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: 10px; margin-bottom: 15px;">
                `;
                
                modules.forEach(module => {
                    levelsHtml += `
                        <div style="background: rgba(46,204,113,0.1); border-radius: 10px; padding: 10px; text-align: center; border: 1px solid rgba(46,204,113,0.3);">
                            <div style="font-family: 'Scheherazade New', 'Amiri', serif; font-size: 2rem; color: #2c3e50; margin-bottom: 5px;">${module.arabic}</div>
                            <div style="font-size: 0.8rem; color: #7f8c8d;">${module.title}</div>
                        </div>
                    `;
                });
                
                levelsHtml += `
                        </div>
                        <div style="text-align: center; font-size: 0.9rem; color: #7f8c8d;">
                            üìä Total: ${modules.length} huruf | üéØ Quiz: 15 soal acak dari huruf level ini
                        </div>
                    </div>
                `;
            });
            
            levelsHtml += `
                <div style="text-align: center; margin-top: 30px;">
                    <button onclick="this.closest('.levels-popup').remove()" style="background: linear-gradient(135deg, #4ecdc4, #44a08d); color: white; border: none; padding: 15px 30px; border-radius: 25px; font-size: 1rem; font-weight: 600; cursor: pointer; box-shadow: 0 8px 25px rgba(78,205,196,0.3);">
                        ‚úÖ Tutup
                    </button>
                </div>
            `;
            
            content.innerHTML = levelsHtml;
            popup.appendChild(content);
            popup.className = 'levels-popup';
            document.body.appendChild(popup);
            
            popup.addEventListener('click', (e) => {
                if (e.target === popup) {
                    popup.remove();
                }
            });
        }

        function addAchievement() {
            const name = document.getElementById('achievementName').value.trim();
            const icon = document.getElementById('achievementIcon').value.trim();
            const description = document.getElementById('achievementDesc').value.trim();
            const condition = document.getElementById('achievementCondition').value;
            const target = parseInt(document.getElementById('achievementTarget').value);
            
            if (!name || !icon || !description || !target) {
                alert('‚ùå Semua field wajib diisi!');
                return;
            }
            
            const newAchievement = {
                id: 'custom_' + Date.now(),
                name: name,
                icon: icon,
                description: description,
                condition: condition,
                target: target
            };
            
            achievements.push(newAchievement);
            localStorage.setItem('blastHijaiyahAchievements', JSON.stringify(achievements));
            
            // Clear form
            document.getElementById('achievementName').value = '';
            document.getElementById('achievementIcon').value = '';
            document.getElementById('achievementDesc').value = '';
            document.getElementById('achievementTarget').value = '';
            
            alert('‚úÖ Achievement berhasil ditambahkan!');
        }

        function showModulesList() {
            // Just redirect to showAllLevels for consistency
            showAllLevels();
        }

        function showAchievementsList() {
            if (achievements.length === 0) {
                alert('‚ùå Belum ada achievement yang dibuat!\n\nSilakan tambah achievement baru di form di atas.');
                return;
            }
            
            const popup = document.createElement('div');
            popup.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 2000;
                backdrop-filter: blur(10px);
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: linear-gradient(135deg, rgba(255,255,255,0.95), rgba(255,255,255,0.85));
                color: #333;
                border-radius: 25px;
                padding: 40px;
                max-width: 700px;
                max-height: 80vh;
                overflow-y: auto;
                box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            `;
            
            let achievementsHtml = '<h2 style="text-align: center; margin-bottom: 30px; color: #2c3e50;">üèÜ Daftar Achievements</h2>';
            
            achievements.forEach((achievement, index) => {
                const unlocked = unlockedAchievements.includes(achievement.id);
                const statusColor = unlocked ? '#27ae60' : '#95a5a6';
                const statusIcon = unlocked ? '‚úÖ' : '‚ùå';
                const statusText = unlocked ? 'UNLOCKED' : 'LOCKED';
                
                achievementsHtml += `
                    <div style="margin-bottom: 20px; background: linear-gradient(135deg, rgba(${unlocked ? '46,204,113' : '149,165,166'},0.1), rgba(${unlocked ? '46,204,113' : '149,165,166'},0.05)); border-radius: 15px; padding: 20px; border: 2px solid rgba(${unlocked ? '46,204,113' : '149,165,166'},0.2);">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="font-size: 2rem;">${achievement.icon}</span>
                                <h3 style="color: #2c3e50; margin: 0;">${achievement.name}</h3>
                            </div>
                            <div style="background: ${statusColor}; color: white; padding: 5px 12px; border-radius: 15px; font-size: 0.8rem; font-weight: 600;">
                                ${statusIcon} ${statusText}
                            </div>
                        </div>
                        <div style="color: #7f8c8d; margin-bottom: 10px; font-size: 0.95rem;">
                            ${achievement.description}
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem;">
                            <div style="color: #2c3e50;">
                                <strong>Target:</strong> ${achievement.target.toLocaleString()} ${achievement.condition === 'score' ? 'poin' : achievement.condition === 'lines' ? 'baris' : achievement.condition === 'combo' ? 'combo' : 'pieces'}
                            </div>
                            ${achievement.id.startsWith('custom_') ? `
                                <button onclick="deleteAchievement('${achievement.id}')" style="background: #e74c3c; color: white; border: none; padding: 5px 10px; border-radius: 8px; font-size: 0.8rem; cursor: pointer;">
                                    üóëÔ∏è Hapus
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
            
            achievementsHtml += `
                <div style="text-align: center; margin-top: 30px;">
                    <button onclick="this.closest('.achievements-popup').remove()" style="background: linear-gradient(135deg, #4ecdc4, #44a08d); color: white; border: none; padding: 15px 30px; border-radius: 25px; font-size: 1rem; font-weight: 600; cursor: pointer; box-shadow: 0 8px 25px rgba(78,205,196,0.3);">
                        ‚úÖ Tutup
                    </button>
                </div>
            `;
            
            content.innerHTML = achievementsHtml;
            popup.appendChild(content);
            popup.className = 'achievements-popup';
            document.body.appendChild(popup);
            
            // Add delete function
            window.deleteAchievement = function(achievementId) {
                if (confirm('üóëÔ∏è Hapus achievement ini?')) {
                    achievements = achievements.filter(a => a.id !== achievementId);
                    unlockedAchievements = unlockedAchievements.filter(id => id !== achievementId);
                    
                    localStorage.setItem('blastHijaiyahAchievements', JSON.stringify(achievements));
                    localStorage.setItem('blastHijaiyahUnlocked', JSON.stringify(unlockedAchievements));
                    
                    popup.remove();
                    alert('‚úÖ Achievement berhasil dihapus!');
                }
            };
            
            popup.addEventListener('click', (e) => {
                if (e.target === popup) {
                    popup.remove();
                }
            });
        }

        function exportAllData() {
            const data = {
                settings: gameSettings,
                levelModules: levelBasedModules,
                legacyModules: learningModules,
                achievements: achievements,
                stats: gameStats,
                unlocked: unlockedAchievements,
                learningProgress: window.learningProgress || {},
                exportDate: new Date().toISOString(),
                version: '2.0'
            };
            
            try {
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `blast-hijaiyah-backup-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                alert('‚úÖ Data berhasil diexport!\n\nüìÅ File: blast-hijaiyah-backup-' + new Date().toISOString().split('T')[0] + '.json\n\nüìä Data yang diexport:\n‚Ä¢ Game Settings\n‚Ä¢ Level Modules\n‚Ä¢ Achievements\n‚Ä¢ Game Stats\n‚Ä¢ Learning Progress');
            } catch (error) {
                alert('‚ùå Error saat export data: ' + error.message);
            }
        }

        function importData() {
            const fileInput = document.getElementById('importFile');
            if (fileInput) {
                fileInput.click();
            } else {
                alert('‚ùå Error: Import file input tidak ditemukan!');
            }
        }

        function handleImport() {
            const file = document.getElementById('importFile').files[0];
            if (!file) return;
            
            if (!file.name.endsWith('.json')) {
                alert('‚ùå Error: Hanya file JSON yang diperbolehkan!');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    let importedItems = [];
                    
                    if (data.settings) {
                        gameSettings = { ...gameSettings, ...data.settings };
                        localStorage.setItem('blastHijaiyahSettings', JSON.stringify(gameSettings));
                        importedItems.push('Game Settings');
                    }
                    
                    if (data.levelModules) {
                        levelBasedModules = { ...levelBasedModules, ...data.levelModules };
                        localStorage.setItem('blastHijaiyahLevelModules', JSON.stringify(levelBasedModules));
                        importedItems.push('Level Modules');
                    }
                    
                    if (data.legacyModules || data.modules) {
                        learningModules = data.legacyModules || data.modules;
                        localStorage.setItem('blastHijaiyahModules', JSON.stringify(learningModules));
                        importedItems.push('Legacy Modules');
                    }
                    
                    if (data.achievements) {
                        achievements = data.achievements;
                        localStorage.setItem('blastHijaiyahAchievements', JSON.stringify(achievements));
                        importedItems.push('Achievements');
                    }
                    
                    if (data.stats) {
                        gameStats = { ...gameStats, ...data.stats };
                        localStorage.setItem('blastHijaiyahStats', JSON.stringify(gameStats));
                        importedItems.push('Game Stats');
                    }
                    
                    if (data.unlocked) {
                        unlockedAchievements = data.unlocked;
                        localStorage.setItem('blastHijaiyahUnlocked', JSON.stringify(unlockedAchievements));
                        importedItems.push('Unlocked Achievements');
                    }
                    
                    if (data.learningProgress) {
                        window.learningProgress = data.learningProgress;
                        localStorage.setItem('blastHijaiyahLearningProgress', JSON.stringify(window.learningProgress));
                        importedItems.push('Learning Progress');
                    }
                    
                    updateAdminDisplay();
                    updateDisplay();
                    
                    alert('‚úÖ Data berhasil diimport!\n\nüìä Data yang diimport:\n‚Ä¢ ' + importedItems.join('\n‚Ä¢ ') + '\n\nüîÑ Refresh halaman jika diperlukan.');
                    
                } catch (error) {
                    alert('‚ùå Error: File tidak valid atau rusak!\n\nDetail: ' + error.message);
                }
            };
            
            reader.onerror = function() {
                alert('‚ùå Error: Gagal membaca file!');
            };
            
            reader.readAsText(file);
        }

        function resetAllData() {
            const confirmText = '‚ö†Ô∏è PERINGATAN!\n\nIni akan menghapus SEMUA data:\n‚Ä¢ Game Settings\n‚Ä¢ Level Modules\n‚Ä¢ Achievements\n‚Ä¢ Game Stats\n‚Ä¢ Learning Progress\n\nApakah Anda yakin?';
            
            if (confirm(confirmText)) {
                const doubleConfirm = confirm('üö® KONFIRMASI TERAKHIR!\n\nSemua progress akan hilang PERMANEN!\n\nLanjutkan reset?');
                
                if (doubleConfirm) {
                    try {
                        // Clear all localStorage data
                        localStorage.removeItem('blastHijaiyahSettings');
                        localStorage.removeItem('blastHijaiyahLevelModules');
                        localStorage.removeItem('blastHijaiyahModules');
                        localStorage.removeItem('blastHijaiyahAchievements');
                        localStorage.removeItem('blastHijaiyahStats');
                        localStorage.removeItem('blastHijaiyahUnlocked');
                        localStorage.removeItem('blastHijaiyahLearningProgress');
                        
                        alert('‚úÖ Semua data berhasil dihapus!\n\nüîÑ Halaman akan di-refresh...');
                        
                        setTimeout(() => {
                            location.reload();
                        }, 1000);
                        
                    } catch (error) {
                        alert('‚ùå Error saat reset data: ' + error.message);
                    }
                }
            }
        }

        // ===== UTILITY FUNCTIONS =====
        function updateDisplay() {
            document.getElementById('scoreValue').textContent = gameStats.score.toLocaleString();
            document.getElementById('linesCleared').textContent = gameStats.linesCleared;
            document.getElementById('comboCount').textContent = gameStats.comboCount;
            document.getElementById('currentLevel').textContent = gameStats.currentLevel;
            document.getElementById('piecesPlaced').textContent = gameStats.piecesPlaced;
        }

        function saveGameData() {
            localStorage.setItem('blastHijaiyahStats', JSON.stringify(gameStats));
        }

        function startNewGame() {
            gameStats = {
                score: 0,
                linesCleared: 0,
                comboCount: 0,
                currentLevel: 1,
                piecesPlaced: 0,
                totalClears: 0
            };
            
            createGameBoard();
            generateNewPieces();
            updateDisplay();
            gameRunning = true;
        }

        function closeGameOver() {
            document.getElementById('gameOverPopup').style.display = 'none';
        }

        function showHowToPlay() {
            alert(`üéÆ Cara Main Blast Hijaiyah:

1. üì± Pilih salah satu dari 3 pieces yang tersedia
2. üéØ Klik di papan untuk menempatkan piece
3. üßπ Clear baris/kolom penuh untuk mendapat poin
4. üî• Clear multiple lines untuk combo bonus
5. üìö Popup pembelajaran muncul secara berkala
6. üèÜ Unlock achievements dengan bermain
7. ‚ùå Game over jika tidak ada space untuk piece

Tips:
‚Ä¢ Rencanakan penempatan dengan hati-hati
‚Ä¢ Cari peluang untuk clear multiple lines
‚Ä¢ Pelajari huruf Arab saat popup muncul
‚Ä¢ Jawab quiz untuk bonus poin!`);
        }

        function showAchievements() {
            showAchievementsList();
        }

        function resetProgress() {
            showResetConfirmation();
        }

        function showResetConfirmation() {
            const popup = document.createElement('div');
            popup.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: linear-gradient(135deg, rgba(0,0,0,0.9), rgba(44,62,80,0.8));
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 2000;
                backdrop-filter: blur(15px);
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: linear-gradient(135deg, #e74c3c 0%, #c0392b 50%, #a93226 100%);
                background-size: 400% 400%;
                animation: gradientShift 8s ease infinite, popupAppear 0.6s ease-out;
                color: white;
                border-radius: 30px;
                padding: 50px;
                max-width: 500px;
                text-align: center;
                box-shadow: 0 30px 80px rgba(0,0,0,0.5), 0 0 50px rgba(231,76,60,0.3);
                border: 3px solid rgba(255,255,255,0.3);
                position: relative;
                overflow: hidden;
            `;
            
            content.innerHTML = `
                <div style="font-size: 4rem; margin-bottom: 20px; animation: pulse 2s ease-in-out infinite;">
                    ‚ö†Ô∏è
                </div>
                <h2 style="font-size: 2.2rem; font-weight: 800; margin-bottom: 25px; color: #fff; text-shadow: 0 3px 10px rgba(0,0,0,0.3);">
                    Reset Progress Game?
                </h2>
                <div style="background: linear-gradient(135deg, rgba(255,255,255,0.2), rgba(255,255,255,0.1)); border-radius: 20px; padding: 25px; margin: 25px 0; border: 2px solid rgba(255,255,255,0.3);">
                    <div style="font-size: 1.3rem; font-weight: 600; margin-bottom: 15px; color: #fff;">
                        üîÑ Yang akan direset:
                    </div>
                    <div style="text-align: left; font-size: 1.1rem; line-height: 1.8; color: #fff;">
                        ‚Ä¢ üìä Semua statistik game (skor, level, combo)<br>
                        ‚Ä¢ üèÜ Semua achievement yang sudah unlock<br>
                        ‚Ä¢ üìö Progress pembelajaran huruf Arab<br>
                        ‚Ä¢ üéÆ Papan game dan pieces<br>
                        ‚Ä¢ ‚öôÔ∏è Semua data di Admin Panel<br>
                        ‚Ä¢ üíæ Data tersimpan di perangkat
                    </div>
                </div>
                <div style="background: linear-gradient(135deg, rgba(255,193,7,0.3), rgba(255,193,7,0.2)); border-radius: 15px; padding: 20px; margin: 20px 0; border: 2px solid rgba(255,193,7,0.5);">
                    <div style="font-size: 1.2rem; font-weight: 600; color: #fff; margin-bottom: 10px;">
                        ‚ö†Ô∏è PERINGATAN
                    </div>
                    <div style="font-size: 1rem; color: #fff;">
                        Semua progress akan hilang PERMANEN dan tidak bisa dikembalikan!
                    </div>
                </div>
                <div style="display: flex; gap: 20px; margin-top: 35px;">
                    <button onclick="confirmReset()" style="flex: 1; background: linear-gradient(135deg, #27ae60, #2ecc71); color: white; border: none; padding: 18px 25px; border-radius: 25px; font-size: 1.2rem; font-weight: 700; cursor: pointer; box-shadow: 0 10px 30px rgba(39,174,96,0.4); border: 2px solid rgba(255,255,255,0.3); transition: all 0.3s ease;">
                        ‚úÖ Ya, Reset!
                    </button>
                    <button onclick="cancelReset()" style="flex: 1; background: linear-gradient(135deg, #95a5a6, #7f8c8d); color: white; border: none; padding: 18px 25px; border-radius: 25px; font-size: 1.2rem; font-weight: 700; cursor: pointer; box-shadow: 0 10px 30px rgba(149,165,166,0.4); border: 2px solid rgba(255,255,255,0.3); transition: all 0.3s ease;">
                        ‚ùå Batal
                    </button>
                </div>
            `;
            
            popup.appendChild(content);
            popup.className = 'reset-confirmation-popup';
            document.body.appendChild(popup);
            
            // Add button hover effects
            const buttons = content.querySelectorAll('button');
            buttons.forEach(button => {
                button.addEventListener('mouseenter', () => {
                    button.style.transform = 'translateY(-3px)';
                    button.style.boxShadow = button.style.boxShadow.replace('10px', '15px');
                });
                button.addEventListener('mouseleave', () => {
                    button.style.transform = 'translateY(0)';
                    button.style.boxShadow = button.style.boxShadow.replace('15px', '10px');
                });
            });
            
            // Add global functions for buttons
            window.confirmReset = function() {
                // Reset game stats
                gameStats = {
                    score: 0,
                    linesCleared: 0,
                    comboCount: 0,
                    currentLevel: 1,
                    piecesPlaced: 0,
                    totalClears: 0
                };
                
                // Reset unlocked achievements
                unlockedAchievements = [];
                
                // Reset learning progress
                window.learningProgress = {};
                
                // Reset admin panel data
                gameSettings = {
                    learningTrigger: 3,
                    scoreMultiplier: 1,
                    comboBonus: 200
                };
                
                levelBasedModules = {};
                learningModules = [];
                
                // Reset achievements to default
                achievements = [
                    {
                        id: 'first_clear',
                        name: 'Pembersih Pertama',
                        icon: 'üßπ',
                        description: 'Clear baris/kolom pertama',
                        condition: 'lines',
                        target: 1
                    },
                    {
                        id: 'combo_master',
                        name: 'Master Combo',
                        icon: 'üî•',
                        description: 'Buat combo 5x berturut-turut',
                        condition: 'combo',
                        target: 5
                    },
                    {
                        id: 'high_scorer',
                        name: 'High Scorer',
                        icon: 'üíé',
                        description: 'Capai skor 10,000',
                        condition: 'score',
                        target: 10000
                    }
                ];
                
                // Save all reset data to localStorage
                localStorage.setItem('blastHijaiyahStats', JSON.stringify(gameStats));
                localStorage.setItem('blastHijaiyahUnlocked', JSON.stringify(unlockedAchievements));
                localStorage.setItem('blastHijaiyahLearningProgress', JSON.stringify(window.learningProgress));
                localStorage.setItem('blastHijaiyahSettings', JSON.stringify(gameSettings));
                localStorage.setItem('blastHijaiyahLevelModules', JSON.stringify(levelBasedModules));
                localStorage.setItem('blastHijaiyahModules', JSON.stringify(learningModules));
                localStorage.setItem('blastHijaiyahAchievements', JSON.stringify(achievements));
                
                // Reset the game board and pieces
                createGameBoard();
                generateNewPieces();
                updateDisplay();
                updateAdminDisplay();
                gameRunning = true;
                
                // Close popup
                popup.remove();
                
                // Show success message
                showResetSuccess();
            };
            
            window.cancelReset = function() {
                popup.remove();
            };
            
            // Close on background click
            popup.addEventListener('click', (e) => {
                if (e.target === popup) {
                    popup.remove();
                }
            });
        }

        function showResetSuccess() {
            const popup = document.createElement('div');
            popup.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: linear-gradient(135deg, rgba(0,0,0,0.8), rgba(44,62,80,0.7));
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 2000;
                backdrop-filter: blur(15px);
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: linear-gradient(135deg, #27ae60 0%, #2ecc71 50%, #58d68d 100%);
                background-size: 400% 400%;
                animation: gradientShift 8s ease infinite, popupAppear 0.6s ease-out;
                color: white;
                border-radius: 30px;
                padding: 50px;
                max-width: 450px;
                text-align: center;
                box-shadow: 0 30px 80px rgba(0,0,0,0.5), 0 0 50px rgba(39,174,96,0.3);
                border: 3px solid rgba(255,255,255,0.3);
                position: relative;
                overflow: hidden;
            `;
            
            content.innerHTML = `
                <div style="font-size: 5rem; margin-bottom: 25px; animation: pulse 2s ease-in-out infinite;">
                    ‚úÖ
                </div>
                <h2 style="font-size: 2.5rem; font-weight: 800; margin-bottom: 20px; color: #fff; text-shadow: 0 3px 10px rgba(0,0,0,0.3);">
                    Reset Berhasil!
                </h2>
                <div style="background: linear-gradient(135deg, rgba(255,255,255,0.2), rgba(255,255,255,0.1)); border-radius: 20px; padding: 25px; margin: 25px 0; border: 2px solid rgba(255,255,255,0.3);">
                    <div style="font-size: 1.3rem; font-weight: 600; margin-bottom: 15px; color: #fff;">
                        üîÑ Progress telah direset:
                    </div>
                    <div style="font-size: 1.1rem; line-height: 1.8; color: #fff;">
                        üìä Stats kembali ke 0<br>
                        üèÜ Achievements dikunci ulang<br>
                        üìö Learning progress direset<br>
                        üéÆ Game board dibersihkan<br>
                        ‚öôÔ∏è Admin Panel dikosongkan<br>
                        üíæ Perubahan tersimpan
                    </div>
                </div>
                <div style="margin-top: 35px;">
                    <button onclick="this.closest('.reset-success-popup').remove()" style="background: linear-gradient(135deg, #fff, #f8f9fa); color: #27ae60; border: none; padding: 18px 35px; border-radius: 25px; font-size: 1.3rem; font-weight: 700; cursor: pointer; box-shadow: 0 10px 30px rgba(255,255,255,0.3); border: 2px solid rgba(255,255,255,0.5); transition: all 0.3s ease;">
                        üéÆ Mulai Main Lagi!
                    </button>
                </div>
            `;
            
            popup.appendChild(content);
            popup.className = 'reset-success-popup';
            document.body.appendChild(popup);
            
            // Add button hover effect
            const button = content.querySelector('button');
            button.addEventListener('mouseenter', () => {
                button.style.transform = 'translateY(-3px) scale(1.05)';
                button.style.boxShadow = '0 15px 40px rgba(255,255,255,0.4)';
            });
            button.addEventListener('mouseleave', () => {
                button.style.transform = 'translateY(0) scale(1)';
                button.style.boxShadow = '0 10px 30px rgba(255,255,255,0.3)';
            });
            
            // Auto close after 5 seconds
            setTimeout(() => {
                if (document.body.contains(popup)) {
                    popup.remove();
                }
            }, 5000);
            
            // Close on background click
            popup.addEventListener('click', (e) => {
                if (e.target === popup) {
                    popup.remove();
                }
            });
        }

        // ===== INITIALIZATION =====
        window.addEventListener('load', () => {
            initGame();
        });

        // Prevent context menu
        document.addEventListener('contextmenu', e => e.preventDefault());
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'978cff50c1f8f892',t:'MTc1NjgxNjAwMy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
